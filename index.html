<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3c72">
    <title>Safelife - V36 (Smart Edition)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --main: #1e3c72; --sec: #2a5298; --accent: #ffc107; --green: #2ecc71; --bg: #f4f7f6; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background-color: var(--bg); padding-bottom: 90px; color: #333; }

        /* Helpers */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; gap: 5px; }
        
        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 380px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 100000; display: none; flex-direction: column; justify-content: center; align-items: center; }

        /* Main Layout */
        #main-app { display: none; }
        header { background: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        
        .page-section { display: none; padding: 15px; padding-bottom: 100px; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Components */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; position: relative; }
        .card-img-wrap { width: 100%; height: 120px; background: #fff; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .card-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .card-body { padding: 8px; text-align: right; flex-grow: 1; }
        
        .order-card { background: white; border-right: 4px solid var(--main); padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-panel { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }

        /* Inputs & Buttons */
        input, select, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100%; margin-bottom: 8px; font-family: 'Cairo'; font-size: 14px; }
        button { cursor: pointer; border:none; border-radius:6px; padding:10px; font-family: 'Cairo'; font-weight: bold; width:100%; margin-bottom:5px; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: #e74c3c; color: white; width:auto; padding:5px 15px; }
        .btn-blue { background: var(--main); color: white; }
        .btn-ghost { background: #eee; color: #333; }
        
        /* Special Inputs */
        .price-input { border: 1px solid #f39c12; background: #fffdf5; font-weight: bold; color: #d35400; text-align: center; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; border-top: 1px solid #eee; height: 60px; }
        .bottom-nav button { background: transparent; color: #aaa; font-size: 10px; width: auto; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 0; }
        .bottom-nav button.active { color: var(--main); }
        .bottom-nav button span { font-size: 20px; margin-bottom: 2px; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size:30px; margin-bottom:10px;">â†»</div>
        <h3 style="color:var(--main);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</h3>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--main);">Safelife Login</h2>
            <input type="text" id="l-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (admin)">
            <input type="password" id="l-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (123)">
            <button class="btn-green" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <p id="error-msg" style="color:#e74c3c; display:none; margin-top:10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <header>
            <div style="font-weight:bold; color:var(--main);">Safelife System</div>
            <div class="flex">
                <span id="head-user" style="font-size:12px; font-weight:bold;"></span>
                <button class="btn-red" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <!-- Dashboard -->
        <div id="page-dashboard" class="page-section active-page">
            <h3>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h3>
            <div class="grid-container">
                <div class="admin-panel" style="text-align:center;">
                    <div style="font-size:20px; font-weight:bold; color:var(--main);" id="dash-sales">0</div>
                    <small>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small>
                </div>
                <div class="admin-panel" style="text-align:center;">
                    <div style="font-size:20px; font-weight:bold; color:var(--green);" id="dash-prods">0</div>
                    <small>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</small>
                </div>
            </div>
            <div class="admin-panel">
                <h5>ğŸ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h5>
                <canvas id="chart-reps"></canvas>
            </div>
        </div>

        <!-- Products (Ordering) -->
        <div id="page-products" class="page-section">
            <div class="admin-panel" style="border: 2px solid var(--sec);">
                <label style="font-size:12px; color:#777;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</label>
                <input type="text" id="current-client" list="clients-list" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¨Ø­Ø«)..." oninput="searchClients(this.value)">
                <datalist id="clients-list"></datalist>
                
                <div class="flex">
                    <input type="text" id="order-location" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†" style="margin:0;">
                    <button class="btn-ghost" style="width:50px; margin:0;" onclick="getGPS()">ğŸ“</button>
                </div>
            </div>

            <!-- Admin Tools -->
            <div id="admin-tools" class="admin-panel hidden" style="background:#fff8e1;">
                <h4>+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h4>
                <input type="hidden" id="edit-id">
                <input type="text" id="np-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                <div class="flex">
                    <input type="number" id="np-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
                    <input type="text" id="np-cat" placeholder="Ø§Ù„Ù‚Ø³Ù…">
                </div>
                <input type="text" id="np-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                <div class="flex">
                    <button class="btn-green" onclick="saveProduct()">Ø­ÙØ¸</button>
                    <button class="btn-red hidden" id="btn-cancel" onclick="cancelEdit()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <div id="products-container" class="grid-container"></div>
        </div>

        <!-- Orders -->
        <div id="page-orders" class="page-section">
            <div class="flex" style="margin-bottom:10px;">
                <button class="btn-blue" onclick="setTab('active')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                <button class="btn-ghost" onclick="setTab('history')">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            </div>
            <div id="orders-container"></div>
        </div>

        <!-- Stocktake -->
        <div id="page-stocktake" class="page-section">
            <h3>ğŸ“‹ Ø§Ù„Ø¬Ø±Ø¯ / Ø§Ù„ØªÙ‚ÙÙŠÙ„</h3>
            <input type="text" id="st-client" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¬Ø±Ø¯...">
            <div style="overflow-x:auto;">
                <table style="min-width:100%;">
                    <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø± (ØªØ¹Ø¯ÙŠÙ„)</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
                    <tbody id="st-table-body"></tbody>
                </table>
            </div>
            <div class="admin-panel" style="margin-top:10px; background:#e8f5e9;">
                <div class="flex" style="justify-content:space-between;">
                    <b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="st-total">0</span></b>
                    <button class="btn-green" style="width:auto;" onclick="saveStocktake()">Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯</button>
                </div>
            </div>
        </div>

        <!-- Admin Users -->
        <div id="page-admin" class="page-section">
            <h3>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <div class="admin-panel">
                <input type="text" id="u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
                <input type="text" id="u-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <div class="flex" style="margin-top:5px;">
                    <label><input type="checkbox" id="u-admin"> Ø£Ø¯Ù…Ù†</label>
                    <label><input type="checkbox" id="u-dist"> Ù…ÙˆØ²Ø¹</label>
                </div>
                <button class="btn-green" onclick="addUser()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
            </div>
            <div id="users-list"></div>
        </div>

        <!-- Navigation -->
        <div class="bottom-nav">
            <button onclick="nav('dashboard')" id="nav-dashboard"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="nav('products')" id="nav-products"><span>ğŸ’Š</span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button onclick="nav('orders')" id="nav-orders"><span>ğŸ“</span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button onclick="nav('stocktake')" id="nav-stocktake" class="hidden"><span>ğŸ“‹</span>Ø§Ù„Ø¬Ø±Ø¯</button>
            <button onclick="nav('admin')" id="nav-admin" class="hidden"><span>âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot, query, where } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS-YWHs-MNaEVzh4G5VEGp_OZKYano1lE",
            authDomain: "safelife-db.firebaseapp.com",
            projectId: "safelife-db",
            storageBucket: "safelife-db.firebasestorage.app",
            messagingSenderId: "778534276398",
            appId: "1:778534276398:web:085e746ed47708a7827ebf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let globalProducts=[], globalOrders=[], globalUsers=[];
        let orderTab = 'active';

        // --- Auth ---
        window.login = async function() {
            let u = document.getElementById("l-user").value;
            let p = document.getElementById("l-pass").value;
            showLoader(true);
            
            // Ø¯Ø®ÙˆÙ„ Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø£ÙˆÙ„
            if(u === 'admin' && p === '123') {
                startApp({user:'Admin', isAdmin:true, canStocktake:true});
                return;
            }

            try {
                const q = query(collection(db,"users"), where("user","==",u), where("pass","==",p));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    let d = snap.docs[0].data(); d.id = snap.docs[0].id;
                    startApp(d);
                } else {
                    document.getElementById("error-msg").style.display="block";
                    showLoader(false);
                }
            } catch(e) { alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); showLoader(false); }
        }

        function startApp(user) {
            currentUser = user;
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("main-app").style.display = "block";
            document.getElementById("head-user").innerText = user.user;

            // Permissions
            if(user.isAdmin) {
                document.getElementById("admin-tools").classList.remove("hidden");
                document.getElementById("nav-admin").classList.remove("hidden");
                document.getElementById("nav-stocktake").classList.remove("hidden");
                listenToUsers();
            }
            if(user.canStocktake) document.getElementById("nav-stocktake").classList.remove("hidden");

            // Listeners
            listenToProducts();
            listenToOrders();
            nav('dashboard');
            showLoader(false);
        }

        // --- Data Listeners ---
        function listenToProducts(){ onSnapshot(collection(db,"products"), s=>{ globalProducts=[]; s.forEach(d=>globalProducts.push({...d.data(),id:d.id})); renderProducts(); }); }
        function listenToOrders(){ onSnapshot(collection(db,"orders"), s=>{ globalOrders=[]; s.forEach(d=>globalOrders.push({...d.data(),id:d.id})); renderOrders(); updateDash(); }); }
        function listenToUsers(){ onSnapshot(collection(db,"users"), s=>{ globalUsers=[]; s.forEach(d=>globalUsers.push({...d.data(),id:d.id})); renderUsers(); }); }

        // --- Product Logic (With Editable Price) ---
        window.saveProduct = async function() {
            let name = document.getElementById("np-name").value;
            let price = document.getElementById("np-price").value;
            let id = document.getElementById("edit-id").value;
            if(!name) return;

            let data = { 
                name, price, 
                cat: document.getElementById("np-cat").value,
                img: document.getElementById("np-img").value 
            };

            if(id) await updateDoc(doc(db,"products",id), data);
            else await addDoc(collection(db,"products"), data);
            
            cancelEdit();
        }

        window.renderProducts = function() {
            let div = document.getElementById("products-container"); div.innerHTML = "";
            let stBody = document.getElementById("st-table-body"); if(stBody) stBody.innerHTML = "";

            globalProducts.forEach(p => {
                let img = p.img || "https://cdn-icons-png.flaticon.com/512/2965/2965363.png";
                
                // 1. Render Product Card (For Orders)
                let adminBtns = currentUser.isAdmin ? `<button onclick="editProd('${p.id}')" style="position:absolute;top:5px;left:5px;width:30px;padding:2px;background:#eee;">âœï¸</button>` : '';
                
                div.innerHTML += `
                <div class="card">
                    ${adminBtns}
                    <div class="card-img-wrap"><img src="${img}"></div>
                    <div class="card-body">
                        <div style="font-weight:bold; font-size:15px; margin-bottom:5px;">${p.name}</div>
                        
                        <!-- Editable Price Input -->
                        <div class="flex" style="margin-bottom:5px;">
                            <label style="font-size:12px;">Ø§Ù„Ø³Ø¹Ø±:</label>
                            <input type="number" class="price-input" id="price-${p.id}" value="${p.price}" style="margin:0;">
                        </div>

                        <div class="flex">
                            <input type="number" id="qty-${p.id}" value="1" style="width:50px; text-align:center; margin:0;">
                            <button class="btn-green" style="margin:0; padding:8px;" onclick="mkOrd('${p.id}')">Ø·Ù„Ø¨</button>
                        </div>
                    </div>
                </div>`;

                // 2. Render Stocktake Row (Also Editable)
                if(stBody) {
                    stBody.innerHTML += `
                    <tr>
                        <td style="text-align:right">${p.name}</td>
                        <td><input type="number" class="price-input" value="${p.price}" data-id="${p.id}" onchange="calcStock()" style="width:60px; margin:0;"></td>
                        <td><input type="number" class="st-qty" data-id="${p.id}" oninput="calcStock()" style="width:50px; margin:0;"></td>
                        <td id="st-sum-${p.id}">0</td>
                    </tr>`;
                }
            });
        }

        window.editProd = function(id) {
            let p = globalProducts.find(x=>x.id===id);
            document.getElementById("edit-id").value = id;
            document.getElementById("np-name").value = p.name;
            document.getElementById("np-price").value = p.price;
            document.getElementById("np-cat").value = p.cat;
            document.getElementById("np-img").value = p.img;
            document.getElementById("admin-tools").classList.remove("hidden");
            document.getElementById("btn-cancel").classList.remove("hidden");
            window.scrollTo(0,0);
        }
        window.cancelEdit = function() {
            document.getElementById("edit-id").value = "";
            document.getElementById("np-name").value = "";
            document.getElementById("np-price").value = "";
            document.getElementById("btn-cancel").classList.add("hidden");
            if(!currentUser.isAdmin) document.getElementById("admin-tools").classList.add("hidden");
        }

        // --- Order Logic (Location & Manual Price) ---
        window.getGPS = function() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById("order-location").value = `${pos.coords.latitude}, ${pos.coords.longitude}`;
                }, () => alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"));
            } else alert("Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
        }

        window.mkOrd = async function(pid) {
            let client = document.getElementById("current-client").value;
            let location = document.getElementById("order-location").value;
            let qty = document.getElementById("qty-"+pid).value;
            let customPrice = document.getElementById("price-"+pid).value; // Get the user-edited price
            let p = globalProducts.find(x=>x.id===pid);

            if(!client) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
            if(qty < 1) return;

            showLoader(true);
            await addDoc(collection(db, "orders"), {
                product: p.name,
                price: customPrice, // Save the edited price
                qty: qty,
                total: qty * customPrice,
                client: client,
                location: location || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                user: currentUser.user,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now(),
                status: 'pending'
            });
            showLoader(false);
            alert("ØªÙ… Ø§Ù„Ø·Ù„Ø¨");
        }

        // --- Orders List & Delivery Note ---
        window.setTab = function(t) {
            orderTab = t; 
            renderOrders();
            // Toggle active styling manually if needed
        }

        window.renderOrders = function() {
            let div = document.getElementById("orders-container"); div.innerHTML = "";
            let list = globalOrders.filter(o => orderTab==='active' ? o.status!=='archived' : o.status==='archived');
            list.sort((a,b) => b.timestamp - a.timestamp);

            list.forEach(o => {
                let actionBtn = "";
                // Ø²Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·
                if(o.status !== 'archived') {
                    actionBtn = `<button class="btn-green" style="padding:5px 10px; width:auto; font-size:12px;" onclick="deliverOrder('${o.id}')">ØªØ³Ù„ÙŠÙ… ğŸšš</button>`;
                } else {
                    // ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
                    actionBtn = `<div style="font-size:11px; color:#d35400;">${o.deliveryNote || "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"}</div>`;
                }

                div.innerHTML += `
                <div class="order-card">
                    <div style="display:flex; justify-content:space-between;">
                        <div style="font-weight:bold;">${o.client}</div>
                        <div style="font-size:12px; color:#777;">${o.date}</div>
                    </div>
                    <div style="font-size:12px; color:#555; margin-bottom:5px;">ğŸ“ ${o.location}</div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:5px; border-radius:5px;">
                        <div>
                            <div>${o.product}</div>
                            <small>Ø¹Ø¯Ø¯: ${o.qty} Ã— Ø³Ø¹Ø±: ${o.price}</small>
                        </div>
                        <div style="text-align:left;">
                            <div style="font-weight:bold; color:var(--main);">${o.total} Ø¬.Ù…</div>
                            ${actionBtn}
                        </div>
                    </div>
                    <div style="font-size:11px; color:#999; margin-top:5px;">Ø¨ÙˆØ§Ø³Ø·Ø©: ${o.user}</div>
                </div>`;
            });
        }

        window.deliverOrder = async function(id) {
            // Ø·Ù„Ø¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„
            let note = prompt("Ù‡Ù„ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠÙ„ØŸ (Ù…Ø«Ø§Ù„: ØµÙ†Ù Ù†Ø§Ù‚ØµØŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±ÙØ¶..)\nØ§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­.");
            
            if(note === null) return; // User cancelled

            showLoader(true);
            await updateDoc(doc(db,"orders",id), {
                status: 'archived',
                deliveryNote: note || "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­"
            });
            showLoader(false);
        }

        // --- Stocktake Calculation ---
        window.calcStock = function() {
            let total = 0;
            document.querySelectorAll("#st-table-body tr").forEach(row => {
                let price = row.querySelector(".price-input").value;
                let qty = row.querySelector(".st-qty").value;
                if(qty > 0) {
                    let sum = price * qty;
                    row.querySelector("td[id^='st-sum']").innerText = sum;
                    total += sum;
                } else {
                    row.querySelector("td[id^='st-sum']").innerText = 0;
                }
            });
            document.getElementById("st-total").innerText = total;
        }

        window.saveStocktake = async function() {
            let client = document.getElementById("st-client").value;
            if(!client) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
            let items = [];
            document.querySelectorAll("#st-table-body tr").forEach(row => {
                let name = row.cells[0].innerText;
                let price = row.querySelector(".price-input").value;
                let qty = row.querySelector(".st-qty").value;
                if(qty > 0) items.push({name, price, qty});
            });

            if(items.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ§Øª");

            await addDoc(collection(db,"stocktakes"), {
                client, items, user: currentUser.user, date: new Date().toLocaleDateString()
            });
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯");
            document.querySelectorAll(".st-qty").forEach(i=>i.value="");
            calcStock();
        }

        // --- Users ---
        window.addUser = async function() {
            let u = document.getElementById("u-name").value;
            let p = document.getElementById("u-pass").value;
            if(!u) return;
            await addDoc(collection(db,"users"), {
                user: u, pass: p, 
                isAdmin: document.getElementById("u-admin").checked,
                canStocktake: true // Default
            });
            document.getElementById("u-name").value = "";
        }
        window.renderUsers = function() {
            let d = document.getElementById("users-list"); d.innerHTML="";
            globalUsers.forEach(u => d.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;">${u.user} (${u.isAdmin?'Admin':'User'})</div>`);
        }

        window.updateDash = function() {
            if(document.getElementById("dash-sales")) {
                document.getElementById("dash-sales").innerText = globalOrders.length;
                document.getElementById("dash-prods").innerText = globalProducts.length;
            }
        }

        // Navigation
        window.nav = function(p) {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active-page'));
            document.getElementById('page-'+p).classList.add('active-page');
            document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
            document.getElementById('nav-'+p).classList.add('active');
            if(p==='orders') renderOrders();
        }
        function showLoader(s) { document.getElementById("loader").style.display = s?"flex":"none"; }

    </script>
</body>
</html>
