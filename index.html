<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3c72">
    <title>Safelife - V35 (Fixed Layout)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --main: #1e3c72; --sec: #2a5298; --accent: #ffc107; --green: #2ecc71; --bg: #f4f7f6; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background-color: var(--bg); padding-bottom: 90px; color: #333; }

        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 380px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 100000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #loader-text { margin-top: 10px; color: var(--main); font-weight: bold; }

        /* App Structure */
        #main-app { display: none; }
        header { background: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        
        .page-section { display: none; padding: 15px; padding-bottom: 100px; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Cards & Grids */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; }
        .card-img-wrap { width: 100%; height: 130px; background: #fff; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .card-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .card-body { padding: 10px; text-align: right; flex-grow: 1; }
        
        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 20px; font-weight: bold; color: var(--main); }
        
        /* Inputs & Buttons */
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin-bottom: 8px; font-family: 'Cairo'; font-size: 14px; }
        button { cursor: pointer; border:none; border-radius:8px; padding:10px; font-family: 'Cairo'; font-weight: bold; width:100%; margin-bottom:5px; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: #e74c3c; color: white; width:auto; padding:5px 15px; }
        .btn-blue { background: var(--main); color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-ghost { background: #eee; color: #333; }

        /* Admin Panels */
        .admin-panel { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .user-card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .check-group { text-align: right; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #fff; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; border-top: 1px solid #eee; height: 60px; }
        .bottom-nav button { background: transparent; color: #aaa; font-size: 10px; width: auto; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 0; }
        .bottom-nav button.active { color: var(--main); }
        .bottom-nav button span { font-size: 20px; margin-bottom: 2px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size:30px; margin-bottom:10px;">â†»</div>
        <h3 style="color:var(--main);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
        <div id="loader-text" style="font-size:12px;"></div>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <img id="app-logo-login" src="https://i.ibb.co/ZRmWMKvR/logo-cmyk-page-0001.jpg" style="width: 180px; margin-bottom: 20px;">
            <h3 style="color:var(--main);">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <input type="text" id="l-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="l-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-green" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn-ghost" onclick="startApp({user:'Ø²Ø§Ø¦Ø±', region:'none', lines:['all'], isAdmin:false})">Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø±</button>
            <p id="error-msg" style="color:#e74c3c; display:none; margin-top:10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <header>
            <img id="app-logo-header" src="https://i.ibb.co/ZRmWMKvR/logo-cmyk-page-0001.jpg" style="height:35px;">
            <span id="head-user" style="font-size:12px; font-weight:bold;"></span>
            <button class="btn-red" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        </header>

        <!-- Dashboard -->
        <div id="page-dashboard" class="page-section active-page">
            <h3>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-num" id="dash-total-sales">0</div>
                    <div style="font-size:12px; color:#777">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-num" id="dash-total-orders">0</div>
                    <div style="font-size:12px; color:#777">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                </div>
            </div>
            <div class="admin-panel">
                <h5>ğŸ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h5>
                <canvas id="chart-reps"></canvas>
            </div>
        </div>

        <!-- Products -->
        <div id="page-products" class="page-section">
            <div class="admin-panel" style="border: 2px solid var(--accent);">
                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <input type="text" id="current-client" list="clients-datalist" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." oninput="searchClients(this.value)">
                <datalist id="clients-datalist"></datalist>
                <input type="text" id="manual-location" placeholder="ÙˆØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...">
                <input type="text" id="order-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª...">
            </div>

            <!-- Admin Add Product -->
            <div id="admin-tools" class="admin-panel" style="display:none; background:#fff8e1;">
                <h4>+ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
                <input type="hidden" id="edit-id">
                <input type="text" id="np-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <div style="display:flex; gap:5px;">
                    <select id="np-cat"></select> <select id="np-salesline"></select>
                </div>
                <input type="text" id="np-desc" placeholder="ÙˆØµÙ">
                <input type="text" id="np-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                <input type="number" id="np-price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <div style="display:flex; gap:5px;">
                    <button class="btn-green" onclick="saveProduct()">Ø­ÙØ¸</button>
                    <button class="btn-ghost" onclick="cancelEditProd()" style="display:none;" id="btn-cancel-prod">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <div id="products-container" class="grid-container"></div>
        </div>

        <!-- Orders -->
        <div id="page-orders" class="page-section">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn-blue" onclick="setOrderTab('active')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                <button class="btn-ghost" onclick="setOrderTab('history')" id="btn-history-tab">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            </div>
            <div id="orders-container"></div>
        </div>

        <!-- Stocktake -->
        <div id="page-stocktake" class="page-section">
            <h3>ğŸ“‹ Ø§Ù„ØªÙ‚ÙÙŠÙ„ / Ø§Ù„Ø¬Ø±Ø¯</h3>
            <div class="admin-panel">
                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <input type="text" id="st-client" list="clients-datalist" placeholder="Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„..." oninput="searchClients(this.value)">
            </div>
            <div style="overflow-x:auto; margin-bottom:15px;">
                <table style="min-width:300px;">
                    <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
                    <tbody id="st-table-body"></tbody>
                </table>
            </div>
            <div class="admin-panel" style="background:#e8f5e9;">
                <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="st-total-before">0</span></div>
                <div style="display:flex; align-items:center; gap:5px; margin:5px 0;">
                    <label>Ø®ØµÙ… %:</label>
                    <input type="number" id="st-discount" style="width:60px; margin:0;" oninput="calculateStocktake()">
                </div>
                <div style="font-weight:bold; font-size:18px; color:green;">Ø§Ù„ØµØ§ÙÙŠ: <span id="st-total-after">0</span></div>
            </div>
            <button class="btn-green" onclick="saveStocktake()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø©</button>
        </div>

        <!-- Admin Settings -->
        <div id="page-admin" class="page-section">
            <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
            
            <!-- Import -->
            <div class="admin-panel">
                <h4 style="color:green;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ù…Ù„Ø§Ø¡ (Excel)</h4>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="file-clients" accept=".xlsx,.xls">
                    <button class="btn-green" onclick="importClients()">Ø±ÙØ¹</button>
                </div>
                <div id="upload-status" style="margin-top:5px; color:blue; font-size:12px;"></div>
                <hr style="margin:10px 0;">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="single-client-name" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">
                    <button class="btn-green" onclick="addSingleClient()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>

            <!-- Maintenance -->
            <div class="admin-panel" style="border:2px solid orange;">
                <h4 style="color:orange;">âš ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h4>
                <div id="cleanup-status" style="color:red; font-size:12px;"></div>
                <button class="btn-warning" onclick="cleanDuplicateClients()">ØªÙ†Ø¸ÙŠÙ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
                <button class="btn-warning" onclick="cleanDuplicateProducts()">ØªÙ†Ø¸ÙŠÙ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            </div>

            <!-- Settings -->
            <div class="admin-panel">
                <h4>Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="sys-logo-url" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                    <button class="btn-green" onclick="saveLogo()">Ø­ÙØ¸</button>
                </div>
            </div>

            <!-- Lists -->
            <div class="admin-panel">
                <h4>Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h4>
                <div style="display:flex; gap:5px;">
                    <select id="sys-type"><option value="cats">Ù‚Ø³Ù…</option><option value="lines">Ù„Ø§ÙŠÙ†</option><option value="regs">Ù…Ù†Ø·Ù‚Ø©</option></select>
                    <input type="text" id="sys-val" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <button class="btn-green" onclick="addSysItem()">+</button>
                </div>
                <div id="sys-lists-container" style="margin-top:10px; font-size:12px;"></div>
            </div>

            <!-- Users -->
            <div class="admin-panel" id="user-form-panel">
                <h4 id="user-form-title">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h4>
                <input type="hidden" id="edit-user-id">
                <input type="text" id="u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="text" id="u-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <input type="text" id="u-job" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label><select id="u-reg-select"></select>
                
                <label style="font-weight:bold; margin-top:10px; display:block;">Ø§Ù„Ù„Ø§ÙŠÙ†Ø§Øª:</label>
                <div class="check-group" id="u-lines-check"></div>

                <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-top:5px;">
                    <label><input type="checkbox" id="perm-admin"> Ø£Ø¯Ù…Ù† ÙƒØ§Ù…Ù„</label><br>
                    <label><input type="checkbox" id="perm-price"> ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª</label><br>
                    <label><input type="checkbox" id="perm-report"> ØªÙ‚Ø§Ø±ÙŠØ±</label><br>
                    <label><input type="checkbox" id="perm-deliver"> Ù…Ù†Ø¯ÙˆØ¨ ØªÙˆØ²ÙŠØ¹</label><br>
                    <label><input type="checkbox" id="perm-stocktake"> Ø¬Ø±Ø¯ / ØªÙ‚ÙÙŠÙ„</label><br>
                    <label><input type="checkbox" id="perm-archive"> Ø£Ø±Ø´ÙŠÙ</label><br>
                    <hr>
                    <label><input type="checkbox" id="perm-linemanager" onchange="toggleLineMgr()"> Ù…Ø´Ø±Ù Ù„Ø§ÙŠÙ†</label>
                    <div id="mgr-regions-box" style="display:none; margin-top:5px;">
                        <small>Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¥Ø´Ø±Ø§Ù:</small>
                        <div class="check-group" id="u-mgr-regions"></div>
                    </div>
                </div>
                
                <div style="display:flex; gap:5px; margin-top:15px;">
                    <button class="btn-green" onclick="saveUser()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    <button class="btn-ghost" id="btn-cancel-user" onclick="cancelEditUser()" style="display:none;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <h4>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h4>
            <div id="users-list"></div>
        </div>

        <div class="bottom-nav">
            <button onclick="nav('dashboard')" id="btn-dashboard"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="nav('products')" id="btn-products"><span>ğŸ’Š</span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button onclick="nav('orders')" id="btn-orders"><span>ğŸ“</span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button onclick="nav('stocktake')" id="btn-stocktake" style="display:none;"><span>ğŸ“‹</span>Ø§Ù„ØªÙ‚ÙÙŠÙ„</button>
            <button onclick="nav('admin')" id="btn-admin" style="display:none;"><span>âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, updateDoc, onSnapshot, query, where, writeBatch, limit } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS-YWHs-MNaEVzh4G5VEGp_OZKYano1lE",
            authDomain: "safelife-db.firebaseapp.com",
            projectId: "safelife-db",
            storageBucket: "safelife-db.firebasestorage.app",
            messagingSenderId: "778534276398",
            appId: "1:778534276398:web:085e746ed47708a7827ebf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let globalProducts=[], globalOrders=[], globalUsers=[];
        let globalSettings = { cats:[], lines:[], regs:[], logo:"" };
        let activeCat='all', activeLine='all';
        let orderTab = 'active';
        const DEFAULT_IMG = "https://cdn-icons-png.flaticon.com/512/2965/2965363.png";
        
        let chartRepsInstance = null;

        // Login
        window.login = async function() {
            let u = document.getElementById("l-user").value;
            let p = document.getElementById("l-pass").value;
            showLoader(true, "Ø¯Ø®ÙˆÙ„...");
            try {
                const q = query(collection(db,"users"), where("user","==",u), where("pass","==",p));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    let d = snap.docs[0].data(); d.id = snap.docs[0].id;
                    startApp(d);
                } else {
                    document.getElementById("error-msg").style.display="block";
                    showLoader(false);
                }
            } catch(e) { alert("Error: "+e.message); showLoader(false); }
        }

        window.startApp = function(user) {
            currentUser = user;
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("main-app").style.display = "block";
            document.getElementById("head-user").innerText = user.user;

            let isVisitor = (user.user === "Ø²Ø§Ø¦Ø±");
            document.getElementById("btn-admin").style.display = user.isAdmin ? "flex" : "none";
            document.getElementById("admin-tools").style.display = (user.isAdmin || user.canPrice) ? "block" : "none";
            
            let canStocktake = user.isAdmin || user.canStocktake;
            document.getElementById("btn-stocktake").style.display = canStocktake ? "flex" : "none";

            document.getElementById("btn-orders").style.display = isVisitor ? "none" : "flex";

            listenToProducts(); listenToOrders(); listenToSettings();
            if(user.isAdmin) listenToUsers();
            
            nav('dashboard');
            showLoader(false);
        }

        // Listeners
        function listenToSettings(){ onSnapshot(doc(db,"settings","config"), d=>{ if(d.exists()){ globalSettings=d.data(); updateUI(); } }); }
        function listenToProducts(){ onSnapshot(collection(db,"products"), s=>{ globalProducts=[]; s.forEach(d=>globalProducts.push({...d.data(),id:d.id})); renderProducts(); }); }
        function listenToOrders(){ onSnapshot(collection(db,"orders"), s=>{ globalOrders=[]; s.forEach(d=>globalOrders.push({...d.data(),id:d.id})); updateDashboard(); renderOrders(); }); }
        function listenToUsers(){ onSnapshot(collection(db,"users"), s=>{ globalUsers=[]; s.forEach(d=>globalUsers.push({...d.data(),id:d.id})); renderUsersTable(); }); }

        // Core Functions
        window.searchClients = async function(val) {
            let dl = document.getElementById("clients-datalist");
            dl.innerHTML = "";
            if(!val || val.length < 2) return;
            try {
                const q = query(collection(db, "clients"), where('name', '>=', val), where('name', '<=', val + '\uf8ff'), limit(10));
                const snap = await getDocs(q);
                snap.forEach(doc => { dl.innerHTML += `<option value="${doc.data().name}">`; });
            } catch(e) { console.error(e); }
        }

        function updateUI() {
            if(globalSettings.logo) {
                document.getElementById("app-logo-login").src = globalSettings.logo;
                document.getElementById("app-logo-header").src = globalSettings.logo;
            }
            let npCat=document.getElementById("np-cat"), npLine=document.getElementById("np-salesline"), uReg=document.getElementById("u-reg-select");
            if(npCat) npCat.innerHTML=(globalSettings.cats||[]).map(c=>`<option value="${c}">${c}</option>`).join("");
            if(npLine) npLine.innerHTML=(globalSettings.lines||[]).map(l=>`<option value="${l}">${l}</option>`).join("");
            if(uReg) uReg.innerHTML=(globalSettings.regs||[]).map(r=>`<option>${r}</option>`).join("");
            
            if(currentUser && currentUser.isAdmin) renderAdminLists();
        }

        function renderProducts() {
            let div = document.getElementById("products-container"); div.innerHTML = "";
            globalProducts.forEach(p => {
                let img = p.img?p.img:DEFAULT_IMG;
                let btns = "";
                if(currentUser && currentUser.user!=="Ø²Ø§Ø¦Ø±") {
                    if(currentUser.isAdmin || currentUser.canPrice) {
                        btns=`<div style="position:absolute; top:5px; left:5px;">
                        <button style="background:#eee; width:30px; padding:2px;" onclick="editProd('${p.id}')">âœï¸</button>
                        <button style="background:#ffeeba; width:30px; padding:2px; color:red;" onclick="delP('${p.id}')">x</button></div>`;
                    }
                }
                div.innerHTML += `
                <div class="card">
                    ${btns}
                    <div class="card-img-wrap"><img src="${img}"></div>
                    <div class="card-body">
                        <div class="prod-title">${p.name}</div>
                        <div class="prod-price" style="margin-top:5px; color:green; font-weight:bold;">${p.price} Ø¬.Ù…</div>
                        <div class="qty-row">
                            <input type="number" value="1" min="1" class="qty-input" id="qty-${p.id}">
                            <button class="add-btn" onclick="mkOrd('${p.id}')">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        window.mkOrd = async function(pid) {
            let p = globalProducts.find(x=>x.id===pid);
            let qty = document.getElementById(`qty-${pid}`).value;
            let client = document.getElementById("current-client").value;
            if(!client) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
            
            showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ù„Ø¨...");
            await addDoc(collection(db,"orders"), {
                product: p.name, price: p.price, qty: qty, total: p.price*qty,
                client: client, user: currentUser.user, region: currentUser.region,
                date: new Date().toLocaleDateString(), status: 'pending'
            });
            showLoader(false);
            alert("ØªÙ…");
        }

        // Stocktake
        window.calculateStocktake = function() {
            let rows = document.querySelectorAll(".st-qty-input");
            let totalBefore = 0;
            rows.forEach(inp => {
                let qty = parseInt(inp.value) || 0;
                let price = parseFloat(inp.dataset.price);
                totalBefore += (qty * price);
                document.getElementById(`st-row-total-${inp.dataset.id}`).innerText = (qty * price).toFixed(1);
            });
            document.getElementById("st-total-before").innerText = totalBefore;
            let disc = parseFloat(document.getElementById("st-discount").value) || 0;
            let totalAfter = totalBefore - ((totalBefore * disc) / 100);
            document.getElementById("st-total-after").innerText = totalAfter.toFixed(1);
        }

        window.renderStocktakeForm = function() {
            let tbody = document.getElementById("st-table-body");
            tbody.innerHTML = "";
            let myProds = globalProducts; 
            // Simple filter for rep lines if needed
            myProds.forEach(p => {
                tbody.innerHTML += `
                <tr>
                    <td style="text-align:right">${p.name}</td>
                    <td>${p.price}</td>
                    <td><input type="number" class="st-qty-input" data-id="${p.id}" data-price="${p.price}" style="width:50px" oninput="calculateStocktake()"></td>
                    <td id="st-row-total-${p.id}">0</td>
                </tr>`;
            });
        }

        window.saveStocktake = async function() {
            let client = document.getElementById("st-client").value;
            if(!client) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
            let items = [];
            document.querySelectorAll(".st-qty-input").forEach(inp => {
                if(inp.value > 0) items.push({name: inp.dataset.name, qty: inp.value});
            });
            if(items.length===0) return alert("Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ§Øª");
            showLoader(true, "Ø­ÙØ¸...");
            await addDoc(collection(db, "stocktakes"), {
                client: client, user: currentUser.user, date: new Date().toLocaleDateString(), items: items
            });
            showLoader(false);
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        }

        // Admin & Users
        function renderAdminLists() {
            let c=document.getElementById("sys-lists-container");
            c.innerHTML = `<b>Lines:</b> `+(globalSettings.lines||[]).map(x=>`<span style="background:#ffeeba; padding:2px 5px; margin:2px; border-radius:4px; display:inline-block;">${x} <span onclick="delSet('lines','${x}')" style="color:red; cursor:pointer;">x</span></span>`).join("") +
            `<br><br><b>Regs:</b> `+(globalSettings.regs||[]).map(x=>`<span style="background:#eee; padding:2px 5px; margin:2px; border-radius:4px; display:inline-block;">${x} <span onclick="delSet('regs','${x}')" style="color:red; cursor:pointer;">x</span></span>`).join("");
            
            let uL=document.getElementById("u-lines-check");
            uL.innerHTML=`<label><input type="checkbox" value="all"> Ø§Ù„ÙƒÙ„</label><br>`;
            (globalSettings.lines||[]).forEach(l=>uL.innerHTML+=`<label style="margin-left:10px"><input type="checkbox" value="${l}"> ${l}</label>`);
            
            let uMgr=document.getElementById("u-mgr-regions");
            uMgr.innerHTML="";
            (globalSettings.regs||[]).forEach(r=>uMgr.innerHTML+=`<label style="margin-left:10px"><input type="checkbox" value="${r}"> ${r}</label>`);
        }

        window.saveUser = async function() {
            let u=document.getElementById("u-name").value;
            let p=document.getElementById("u-pass").value;
            let id = document.getElementById("edit-user-id").value;
            if(!u) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
            
            let data = {
                user: u, pass: p, 
                region: document.getElementById("u-reg-select").value,
                isAdmin: document.getElementById("perm-admin").checked,
                canPrice: document.getElementById("perm-price").checked,
                canStocktake: document.getElementById("perm-stocktake").checked
            };
            
            showLoader(true, "Ø­ÙØ¸...");
            if(id) { await updateDoc(doc(db,"users",id), data); }
            else { await addDoc(collection(db,"users"), data); }
            alert("ØªÙ…"); showLoader(false);
            window.location.reload(); // Refresh to clean form
        }

        window.editUser = function(id) {
            let u = globalUsers.find(x=>x.id===id);
            document.getElementById("u-name").value = u.user;
            document.getElementById("u-pass").value = u.pass;
            document.getElementById("edit-user-id").value = id;
            document.getElementById("perm-admin").checked = u.isAdmin;
            document.getElementById("perm-stocktake").checked = u.canStocktake;
            document.getElementById("btn-cancel-user").style.display = "inline-block";
            window.scrollTo(0,0);
        }

        window.delUser = async function(id) { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db,"users",id)); }

        function renderUsersTable() {
            let d = document.getElementById("users-list"); d.innerHTML="";
            globalUsers.forEach(u => {
                d.innerHTML += `<div class="user-card">
                    <div><b>${u.user}</b> <small>(${u.region})</small></div>
                    <div><button style="width:30px; background:#eee;" onclick="editUser('${u.id}')">âœï¸</button>
                    <button style="width:30px; background:red; color:white;" onclick="delUser('${u.id}')">x</button></div>
                </div>`;
            });
        }

        function updateDashboard() {
            if(!document.getElementById("page-dashboard")) return;
            document.getElementById("dash-total-orders").innerText = globalOrders.length;
            // Simple Chart
            let ctx = document.getElementById("chart-reps").getContext('2d');
            if(chartRepsInstance) chartRepsInstance.destroy();
            let repData = {}; 
            globalOrders.forEach(o => repData[o.user] = (repData[o.user]||0)+1);
            chartRepsInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(repData), datasets: [{ label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª', data: Object.values(repData), backgroundColor: '#1e3c72' }] }
            });
        }

        // Nav
        window.nav = function(p) {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active-page'));
            document.getElementById('page-'+p).classList.add('active-page');
            document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+p).classList.add('active');
            if(p==='orders') renderOrders();
            if(p==='stocktake') renderStocktakeForm();
            if(p==='dashboard') updateDashboard();
        }

        function showLoader(s, t) {
            document.getElementById("loader").style.display = s ? "flex" : "none";
            document.getElementById("loader-text").innerText = t || "";
        }

        listenToSettings();
    </script>
</body>
</html>
