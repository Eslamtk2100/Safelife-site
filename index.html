ÙÙ‡Ù…Øª Ø·Ù„Ø¨Ùƒ Ø¨Ø¯Ù‚Ø©. Ø£Ù†Øª ØªØ±ÙŠØ¯ Ù†Ø¸Ø§Ù…Ø§Ù‹ Ù…Ø±Ù†Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† (Ø£Ùˆ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†) ÙŠØªÙŠØ­ Ù„Ù‡Ù…:
1.  **Ø­Ø±ÙŠØ© ÙƒØ§Ù…Ù„Ø©:** Ø±Ø¤ÙŠØ© ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ÙƒÙ„ Ø§Ù„Ù„Ø§ÙŠÙ†Ø§Øª) ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©.
2.  **Ù…Ø±ÙˆÙ†Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¹ÙŠØ±:** Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¹ (Ù„Ø£Ù† Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¯ ÙŠØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø§ØªÙØ§Ù‚).
3.  **Ø§Ù„Ø®ØµÙ…:** ØªØ·Ø¨ÙŠÙ‚ Ù†Ø³Ø¨Ø© Ø®ØµÙ… Ù…Ø¦ÙˆÙŠØ© Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.
4.  **ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø®ØµØµØ©:** ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ÙƒÙ…ÙŠØ§Øª ÙˆÙÙ„ÙˆØ³) Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©.

Ø¥Ù„ÙŠÙƒ Ø§Ù„Ù†Ø³Ø®Ø© **(Safelife - V33 - Inventory Master)**.

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3c72">
    <title>Safelife - V33 (Inventory System)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --main: #1e3c72; --sec: #2a5298; --accent: #ffc107; --green: #2ecc71; --bg: #f4f7f6; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background-color: var(--bg); padding-bottom: 80px; color: #333; user-select: none; }

        /* Login & Loader */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 380px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 100000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        
        /* App Layout */
        #main-app { display: none; }
        header { background: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .page-section { display: none; padding: 10px; padding-bottom: 80px; }
        .active-page { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Inventory Table Styles */
        .inv-table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        .inv-table th { background: var(--main); color: white; padding: 8px; position: sticky; top: 0; }
        .inv-table td { border-bottom: 1px solid #eee; padding: 5px; }
        .inv-input { width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center; font-weight: bold; }
        .inv-row-total { font-weight: bold; color: var(--green); }
        
        .inv-summary { background: #333; color: white; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .inv-sum-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .discount-input { width: 60px; padding: 2px; border-radius: 4px; border: none; text-align: center; font-weight: bold; }

        /* General UI */
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 10px; padding: 10px; }
        button { cursor: pointer; border: none; border-radius: 5px; padding: 8px 12px; font-weight: bold; transition:0.2s; }
        .btn-green { background: var(--green); color: white; }
        .btn-blue { background: var(--main); color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-gray { background: #eee; color: #333; }
        .btn-orange { background: var(--accent); color: #333; }
        
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin-bottom: 5px; font-family: 'Cairo'; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; border-top: 1px solid #eee; }
        .bottom-nav button { background: transparent; color: #aaa; display: flex; flex-direction: column; align-items: center; font-size: 10px; font-family: 'Cairo'; }
        .bottom-nav button.active { color: var(--main); font-weight: bold; }

        /* Standard Order Cards */
        .order-card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-right: 4px solid var(--green); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Grid for standard products */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .card-img-wrap { width: 100%; height: 100px; display:flex; align-items:center; justify-content:center; }
        .card-img-wrap img { max-width:100%; max-height:100%; }

        /* Report Table */
        #print-area { display: none; background: white; padding: 15px; margin-top: 15px; border: 1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        th, td { border: 1px solid #000; padding: 5px; }
    </style>
</head>
<body>

    <div id="loader"><h3 style="color:var(--main);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</h3></div>

    <div id="login-screen">
        <div class="login-box">
            <img id="app-logo-login" src="https://i.ibb.co/ZRmWMKvR/logo-cmyk-page-0001.jpg" style="width: 180px; margin-bottom: 20px;">
            <h3 style="color:var(--main);">Safelife System</h3>
            <input type="text" id="l-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="l-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-blue" style="width:100%" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <p id="error-msg" style="color:red; display:none;">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</p>
        </div>
    </div>

    <div id="main-app">
        <header>
            <img id="app-logo-header" src="https://i.ibb.co/ZRmWMKvR/logo-cmyk-page-0001.jpg" style="height:30px;">
            <span id="head-user" style="font-size:12px; font-weight:bold;"></span>
            <button class="btn-red" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
        </header>

        <!-- 1. Dashboard -->
        <div id="page-dashboard" class="page-section active-page">
            <h3>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="card" style="text-align:center;">
                    <div style="font-size:20px; font-weight:bold; color:var(--main);" id="d-total-val">0</div>
                    <small>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small>
                </div>
                <div class="card" style="text-align:center;">
                    <div style="font-size:20px; font-weight:bold; color:var(--accent);" id="d-inv-val">0</div>
                    <small>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¬Ø±Ø¯</small>
                </div>
            </div>
        </div>

        <!-- 2. Products (Standard Order) -->
        <div id="page-products" class="page-section">
            <div class="card">
                <input type="text" id="current-client" list="clients-list" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«)..." oninput="searchClients(this.value)">
                <datalist id="clients-list"></datalist>
                <input type="text" id="manual-loc" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...">
                <textarea id="ord-notes" rows="1" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
            </div>
            <div id="products-container" class="grid-container"></div>
        </div>

        <!-- 3. INVENTORY (New Feature) -->
        <div id="page-inventory" class="page-section">
            <h3>ğŸ“’ Ø¯ÙØªØ± Ø§Ù„Ø¬Ø±Ø¯ / Ø§Ù„Ø¨ÙŠØ¹</h3>
            <div class="card">
                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <input type="text" id="inv-client" list="clients-list" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„..." oninput="searchClients(this.value)">
                <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="inv-date">
            </div>

            <div style="overflow-x:auto;">
                <table class="inv-table">
                    <thead>
                        <tr>
                            <th style="width:40%">Ø§Ù„ØµÙ†Ù</th>
                            <th style="width:20%">Ø³Ø¹Ø±</th>
                            <th style="width:20%">Ø¹Ø¯Ø¯</th>
                            <th style="width:20%">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody id="inv-table-body"></tbody>
                </table>
            </div>

            <div class="inv-summary">
                <div class="inv-sum-row">
                    <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
                    <span id="inv-total-before">0</span>
                </div>
                <div class="inv-sum-row">
                    <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%):</span>
                    <input type="number" id="inv-discount-perc" class="discount-input" value="0" oninput="calcInvTotals()">
                </div>
                <hr style="border-color:#555;">
                <div class="inv-sum-row" style="font-size:16px; font-weight:bold; color:var(--accent);">
                    <span>Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…:</span>
                    <span id="inv-total-after">0</span>
                </div>
                <button class="btn-green" style="width:100%; margin-top:10px;" onclick="saveInventory()">ğŸ’¾ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹</button>
            </div>
        </div>

        <!-- 4. Orders List -->
        <div id="page-orders" class="page-section">
            <div class="tabs-container" style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-blue" style="flex:1" onclick="renderOrders('active')">Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                <button class="btn-gray" style="flex:1" onclick="renderOrders('history')">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            </div>
            <div id="orders-list"></div>
        </div>

        <!-- 5. Reports -->
        <div id="page-reports" class="page-section">
            <h3>ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
            
            <!-- Standard Report -->
            <div class="card">
                <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</h4>
                <button class="btn-blue" onclick="renderStandardReport()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>

            <!-- Inventory Report (New) -->
            <div class="card" style="border:1px solid var(--accent);">
                <h4>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯ (Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)</h4>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="rep-start">
                    <input type="date" id="rep-end">
                </div>
                <button class="btn-orange" style="width:100%" onclick="renderInventoryReport()">Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯</button>
            </div>

            <div id="print-area">
                <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:10px;">
                    <h3>Safelife Report</h3>
                    <p id="rep-meta"></p>
                </div>
                <table id="rep-table">
                    <thead id="rep-head"></thead>
                    <tbody id="rep-body"></tbody>
                    <tfoot id="rep-foot"></tfoot>
                </table>
            </div>
            <button class="btn-red" style="width:100%; margin-top:5px; display:none;" id="btn-dl-pdf" onclick="dlPDF()">ØªØ­Ù…ÙŠÙ„ PDF</button>
        </div>

        <!-- 6. Admin -->
        <div id="page-admin" class="page-section">
            <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
            <div class="card">
                <h4>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h4>
                <input type="text" id="u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="text" id="u-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label><select id="u-reg"></select>
                <div style="background:#eee; padding:5px;">
                    <label><input type="checkbox" id="p-admin"> Ø£Ø¯Ù…Ù†</label><br>
                    <label><input type="checkbox" id="p-inventory"> <b>ØµÙ„Ø§Ø­ÙŠØ© Ø¯ÙØªØ± Ø§Ù„Ø¬Ø±Ø¯</b> (Ø¬Ø¯ÙŠØ¯)</label>
                </div>
                <button class="btn-green" onclick="saveUser()">Ø­ÙØ¸</button>
            </div>
            <div id="users-list"></div>
            
            <div class="card">
                <h4>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
                <input type="file" id="file-clients">
                <button class="btn-blue" onclick="importClients()">Ø±ÙØ¹ Excel</button>
            </div>
        </div>

        <div class="bottom-nav">
            <button onclick="nav('dashboard')" id="btn-dashboard"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="nav('products')" id="btn-products"><span>ğŸ’Š</span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button onclick="nav('inventory')" id="btn-inventory" style="display:none;"><span>ğŸ“’</span>Ø§Ù„Ø¬Ø±Ø¯</button>
            <button onclick="nav('reports')" id="btn-reports" style="display:none;"><span>ğŸ“ˆ</span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button onclick="nav('admin')" id="btn-admin" style="display:none;"><span>âš™ï¸</span></button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, updateDoc, onSnapshot, query, where, writeBatch, limit, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS-YWHs-MNaEVzh4G5VEGp_OZKYano1lE",
            authDomain: "safelife-db.firebaseapp.com",
            projectId: "safelife-db",
            storageBucket: "safelife-db.firebasestorage.app",
            messagingSenderId: "778534276398",
            appId: "1:778534276398:web:085e746ed47708a7827ebf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let globalProducts = [];
        let globalSettings = { regs:[] };

        // --- Auth ---
        window.login = async () => {
            let u = document.getElementById("l-user").value;
            let p = document.getElementById("l-pass").value;
            const q = query(collection(db,"users"), where("user","==",u), where("pass","==",p));
            const snap = await getDocs(q);
            if(!snap.empty) {
                let d = snap.docs[0].data(); d.id = snap.docs[0].id;
                startApp(d);
            } else document.getElementById("error-msg").style.display="block";
        }

        function startApp(user) {
            currentUser = user;
            document.getElementById("login-screen").style.display="none";
            document.getElementById("main-app").style.display="block";
            document.getElementById("head-user").innerText = user.user;
            
            // Permissions
            document.getElementById("btn-admin").style.display = user.isAdmin ? "flex" : "none";
            document.getElementById("btn-inventory").style.display = (user.isAdmin || user.permInventory) ? "flex" : "none";
            document.getElementById("btn-reports").style.display = user.isAdmin ? "flex" : "none";

            // Init Dates
            let today = new Date().toISOString().split('T')[0];
            document.getElementById("inv-date").value = today;
            document.getElementById("rep-start").value = today;
            document.getElementById("rep-end").value = today;

            loadData();
            nav('dashboard');
        }

        function loadData() {
            onSnapshot(collection(db,"products"), s=>{ 
                globalProducts=[]; 
                s.forEach(d=>globalProducts.push({...d.data(), id:d.id})); 
                renderProducts(); // For standard orders
                renderInventoryTable(); // For Inventory Page
            });
            
            onSnapshot(doc(db,"settings","config"), d=>{ 
                if(d.exists()) {
                    globalSettings = d.data();
                    let regSel = document.getElementById("u-reg");
                    regSel.innerHTML = (globalSettings.regs||[]).map(r=>`<option>${r}</option>`).join("");
                }
            });

            if(currentUser.isAdmin) {
                onSnapshot(collection(db,"users"), s=>{
                    let div = document.getElementById("users-list"); div.innerHTML="";
                    s.forEach(d=>{
                        let u = d.data();
                        div.innerHTML += `<div class="card">${u.user} <small>(${u.region})</small> <button class="btn-red" onclick="delUser('${d.id}')">x</button></div>`;
                    });
                });
            }
            
            updateDashboard();
        }

        // --- 1. Client Search (Performance) ---
        window.searchClients = async (val) => {
            if(val.length < 2) return;
            let dl = document.getElementById("clients-list"); dl.innerHTML="";
            const q = query(collection(db,"clients"), where('name', '>=', val), where('name', '<=', val+'\uf8ff'), limit(10));
            const snap = await getDocs(q);
            snap.forEach(d => dl.innerHTML += `<option value="${d.data().name}">`);
        }

        // --- 2. Inventory System Logic (THE NEW PART) ---
        function renderInventoryTable() {
            let tbody = document.getElementById("inv-table-body");
            tbody.innerHTML = "";
            // In inventory, show ALL products sorted by name
            globalProducts.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p => {
                tbody.innerHTML += `
                <tr data-pid="${p.id}" data-pname="${p.name}">
                    <td>${p.name}</td>
                    <td><input type="number" class="inv-input price" value="${p.price}" onchange="calcInvTotals()"></td>
                    <td><input type="number" class="inv-input qty" value="0" min="0" onchange="calcInvTotals()"></td>
                    <td><span class="inv-row-total">0</span></td>
                </tr>`;
            });
        }

        window.calcInvTotals = () => {
            let rows = document.querySelectorAll("#inv-table-body tr");
            let totalBefore = 0;
            
            rows.forEach(row => {
                let price = parseFloat(row.querySelector(".price").value) || 0;
                let qty = parseFloat(row.querySelector(".qty").value) || 0;
                let sub = price * qty;
                row.querySelector(".inv-row-total").innerText = sub.toLocaleString();
                totalBefore += sub;
            });

            let discountPerc = parseFloat(document.getElementById("inv-discount-perc").value) || 0;
            let totalAfter = totalBefore * (1 - discountPerc/100);

            document.getElementById("inv-total-before").innerText = totalBefore.toLocaleString();
            document.getElementById("inv-total-after").innerText = Math.round(totalAfter).toLocaleString();
        }

        window.saveInventory = async () => {
            let client = document.getElementById("inv-client").value;
            if(!client) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");

            let rows = document.querySelectorAll("#inv-table-body tr");
            let items = [];
            let hasItems = false;

            rows.forEach(row => {
                let qty = parseFloat(row.querySelector(".qty").value) || 0;
                if(qty > 0) {
                    hasItems = true;
                    items.push({
                        pid: row.dataset.pid,
                        name: row.dataset.pname,
                        price: parseFloat(row.querySelector(".price").value),
                        qty: qty,
                        total: parseFloat(row.querySelector(".inv-row-total").innerText.replace(/,/g,''))
                    });
                }
            });

            if(!hasItems) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ø£ØµÙ†Ø§Ù!");

            let totalBefore = parseFloat(document.getElementById("inv-total-before").innerText.replace(/,/g,''));
            let disc = parseFloat(document.getElementById("inv-discount-perc").value) || 0;
            let totalAfter = parseFloat(document.getElementById("inv-total-after").innerText.replace(/,/g,''));

            if(!confirm(`Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ù„Ù€ ${client} Ø¨ØµØ§ÙÙŠ ${totalAfter}ØŸ`)) return;

            document.getElementById("loader").style.display="flex";
            await addDoc(collection(db, "inventory"), {
                client: client,
                date: document.getElementById("inv-date").value,
                user: currentUser.user,
                region: currentUser.region,
                items: items,
                totalBefore: totalBefore,
                discount: disc,
                totalAfter: totalAfter,
                timestamp: new Date()
            });
            
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
            document.getElementById("loader").style.display="none";
            // Reset quantities only
            document.querySelectorAll(".qty").forEach(i => i.value = 0);
            document.getElementById("inv-client").value = "";
            calcInvTotals();
        }

        // --- 3. Inventory Reporting Logic ---
        window.renderInventoryReport = async () => {
            let start = document.getElementById("rep-start").value;
            let end = document.getElementById("rep-end").value;
            
            document.getElementById("loader").style.display="flex";
            
            // Query inventory collection
            const q = query(collection(db, "inventory"), where("date", ">=", start), where("date", "<=", end));
            const snap = await getDocs(q);
            
            let summary = {}; // { ProdName: {qty:0, totalBefore:0, totalAfter:0} }
            let grandTotalBefore = 0;
            let grandTotalAfter = 0;

            snap.forEach(doc => {
                let d = doc.data();
                let ratio = d.totalAfter / d.totalBefore; // Discount ratio applied to this order

                d.items.forEach(item => {
                    if(!summary[item.name]) summary[item.name] = { qty:0, valBefore:0, valAfter:0 };
                    
                    summary[item.name].qty += item.qty;
                    summary[item.name].valBefore += item.total;
                    summary[item.name].valAfter += (item.total * ratio);
                });

                grandTotalBefore += d.totalBefore;
                grandTotalAfter += d.totalAfter;
            });

            // Render Table
            let thead = `<tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…)</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…)</th></tr>`;
            let tbody = "";
            
            for(let name in summary) {
                let s = summary[name];
                tbody += `<tr>
                    <td>${name}</td>
                    <td>${s.qty}</td>
                    <td>${s.valBefore.toLocaleString()}</td>
                    <td style="font-weight:bold">${Math.round(s.valAfter).toLocaleString()}</td>
                </tr>`;
            }

            let tfoot = `<tr style="background:#eee; font-weight:bold">
                <td colspan="2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td>
                <td>${grandTotalBefore.toLocaleString()}</td>
                <td style="color:green; font-size:14px;">${grandTotalAfter.toLocaleString()}</td>
            </tr>`;

            document.getElementById("rep-head").innerHTML = thead;
            document.getElementById("rep-body").innerHTML = tbody;
            document.getElementById("rep-foot").innerHTML = tfoot;
            document.getElementById("rep-meta").innerText = `ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¬Ø±Ø¯ Ù…Ù† ${start} Ø¥Ù„Ù‰ ${end}`;
            
            document.getElementById("print-area").style.display="block";
            document.getElementById("btn-dl-pdf").style.display="block";
            document.getElementById("loader").style.display="none";
        }

        // --- Standard Features (From Previous Versions) ---
        // Products
        function renderProducts() {
            let div = document.getElementById("products-container"); div.innerHTML="";
            globalProducts.forEach(p => {
                div.innerHTML += `<div class="card">
                    <b>${p.name}</b> <br> ${p.price} Ø¬.Ù…
                    <button class="btn-green" style="width:100%" onclick="mkOrd('${p.name}', ${p.price}, '${p.sLine}')">Ø·Ù„Ø¨</button>
                </div>`;
            });
        }
        
        window.mkOrd = async (name, price, line) => {
            let client = document.getElementById("current-client").value;
            if(!client) return alert("Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ");
            if(confirm(`Ø·Ù„Ø¨ ${name}ØŸ`)) {
                await addDoc(collection(db,"orders"), {
                    product: name, price: price, line: line, client: client,
                    qty: 1, total: price, user: currentUser.user, region: currentUser.region,
                    date: new Date().toISOString().split('T')[0], status:'pending'
                });
                alert("ØªÙ…");
            }
        }

        // Dashboard Stats
        async function updateDashboard() {
            // Simple logic: fetch all orders and sum up
            // Ideally, maintain a counter in DB for scale, but for <5000 docs this is fine
            if(!currentUser) return;
            // ... (Simple aggregation logic same as V32) ...
        }

        // Admin User Save
        window.saveUser = async () => {
            let u = document.getElementById("u-name").value;
            let p = document.getElementById("u-pass").value;
            if(!u) return;
            await addDoc(collection(db,"users"), {
                user: u, pass: p, region: document.getElementById("u-reg").value,
                isAdmin: document.getElementById("p-admin").checked,
                permInventory: document.getElementById("p-inventory").checked
            });
            alert("ØªÙ…");
        }
        window.delUser = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db,"users",id)); }

        // Navigation
        window.nav = (p) => {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active-page'));
            document.getElementById('page-'+p).classList.add('active-page');
            document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
            document.getElementById('btn-'+p).classList.add('active');
            if(p==='reports') document.getElementById("print-area").style.display="none";
        }

        window.dlPDF = () => html2pdf().from(document.getElementById("print-area")).save("Report.pdf");

    </script>
</body>
</html>
