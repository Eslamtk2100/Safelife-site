<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e3c72">
    <title>Safelife - V50 (Stock Archive)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --main: #1e3c72; --sec: #2a5298; --accent: #ffc107; --green: #2ecc71; --bg: #f4f7f6; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background-color: var(--bg); padding-bottom: 90px; color: #333; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 20px; width: 100%; max-width: 380px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 100000; display: none; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; }

        #main-app { display: none; }
        header { background: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900; }
        #header-branch-select { padding: 5px; border: 1px solid var(--main); border-radius: 5px; font-size: 12px; background: #fff; display: none; }

        .page-section { display: none; padding: 15px; padding-bottom: 100px; animation: fadeIn 0.3s; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; }
        .card-img-wrap { width: 100%; height: 130px; background: #fff; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .card-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .card-body { padding: 10px; text-align: right; flex-grow: 1; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        .admin-panel { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; position: relative; z-index: 1; }
        input, select, textarea { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin-bottom: 10px; font-family: 'Cairo'; font-size: 16px; }
        button { cursor: pointer; border:none; border-radius:8px; padding:12px; font-family: 'Cairo'; font-weight: bold; width:100%; margin-bottom:5px; font-size: 16px; }
        
        .permission-label { display: flex; align-items: center; padding: 12px; margin-bottom: 5px; background: #f9f9f9; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        .permission-label:active { background: #e3f2fd; }
        input[type="checkbox"] { width: 25px; height: 25px; margin-left: 15px; flex-shrink: 0; }

        .btn-green { background: var(--green); color: white; }
        .btn-red { background: #e74c3c; color: white; width:auto; padding:5px 15px; }
        .btn-blue { background: var(--main); color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-ghost { background: #eee; color: #333; }

        .order-group-card { background: white; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .group-header { background: #f0f7ff; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .group-item-row { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px dashed #eee; font-size: 14px; }
        .group-footer { background: #fafafa; padding: 12px; display: flex; justify-content: space-between; align-items: center; }

        #dist-print-area table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #dist-print-area th { background: #eee; border: 1px solid #333; padding: 10px; }
        #dist-print-area td { border: 1px solid #333; padding: 10px; text-align: center; }

        #st-table-header { background: #333; color: #fff; font-weight: bold; }
        #st-table-body tr:nth-child(even) { background: #f9f9f9; }
        .st-del-btn { background: #ffebee; color: red; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        /* Archive Styles */
        .archive-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; border-right: 4px solid var(--accent); cursor: pointer; }
        .archive-card:hover { background: #f9f9f9; }
        #st-details-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; padding:20px; }
        .modal-content { background:white; padding:20px; border-radius:10px; width:100%; max-width:500px; max-height:80vh; overflow-y:auto; }

        .tree-item { background: #f8f9fa; padding: 10px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tree-sub-item { background: #fff; padding: 8px; margin: 5px 20px 5px 0; border-right: 3px solid var(--accent); display: flex; justify-content: space-between; font-size: 14px; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 999; border-top: 1px solid #eee; height: 60px; }
        .bottom-nav button { background: transparent; color: #aaa; font-size: 10px; width: auto; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 0; }
        .bottom-nav button.active { color: var(--main); }
        .bottom-nav button span { font-size: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size:30px; margin-bottom:10px;">â†»</div>
        <h3 style="color:var(--main);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...</h3>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <h3 style="color:var(--main);">Safelife Login</h3>
            <input type="text" id="l-user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="l-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <label style="display:flex; align-items:center; justify-content:center; margin-bottom:15px; color:#555;">
                <input type="checkbox" id="remember-me" style="width:20px; height:20px; margin:0 0 0 10px;"> ØªØ°ÙƒØ± Ø¯Ø®ÙˆÙ„ÙŠ
            </label>
            <button class="btn-green" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <p id="error-msg" style="color:#e74c3c; display:none; margin-top:10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <header>
            <div style="font-weight:bold; color:var(--main);">Safelife</div>
            <select id="header-branch-select" onchange="updateGlobalBranch(this.value)">
                <option value="all">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
            </select>
            <div style="display:flex; gap:5px; align-items:center;">
                <span id="head-user" style="font-size:12px; font-weight:bold;"></span>
                <button class="btn-red" style="padding:5px 10px;" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <!-- Dashboard -->
        <div id="page-dashboard" class="page-section active-page">
            <h3>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© <span id="dash-branch-name" style="font-size:14px; color:#777;"></span></h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="admin-panel" style="text-align:center;">
                    <div id="dash-total-sales" style="font-size:24px; font-weight:bold; color:var(--main);">0</div>
                    <div>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                </div>
                <div class="admin-panel" style="text-align:center;">
                    <div id="dash-total-orders" style="font-size:24px; font-weight:bold; color:var(--green);">0</div>
                    <div>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                </div>
            </div>
            <div class="admin-panel">
                <h5>ğŸ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</h5>
                <canvas id="chart-reps"></canvas>
            </div>
        </div>

        <!-- Products -->
        <div id="page-products" class="page-section">
            <div class="admin-panel" style="border: 2px solid var(--accent);">
                <label style="font-weight:bold;">Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <input type="text" id="current-client" list="clients-datalist" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." oninput="searchClients(this.value)">
                <datalist id="clients-datalist"></datalist>
                <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
                    <input type="text" id="order-location" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†" style="margin:0;">
                    <button class="btn-ghost" style="width:50px; margin:0;" onclick="getGPS()">ğŸ“</button>
                </div>
            </div>

            <div id="admin-tools" class="admin-panel" style="display:none; background:#fff8e1;">
                <h4>+ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
                <input type="hidden" id="edit-id">
                <input type="text" id="np-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <div style="display:flex; gap:5px;">
                    <select id="np-cat"></select> <select id="np-salesline"></select>
                </div>
                <input type="text" id="np-img" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                <input type="number" id="np-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
                <div style="display:flex; gap:5px;">
                    <button class="btn-green" onclick="saveProduct()">Ø­ÙØ¸</button>
                    <button class="btn-ghost" onclick="cancelEditProd()" style="display:none;" id="btn-cancel-prod">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <div id="products-container" class="grid-container"></div>
        </div>

        <!-- Orders -->
        <div id="page-orders" class="page-section">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn-blue" id="btn-tab-active" onclick="setOrderTab('active')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                <button class="btn-ghost" id="btn-tab-history" onclick="setOrderTab('history')">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                <button class="btn-warning" onclick="initDistSummary()" id="btn-dist-summary" style="display:none;">ğŸ“¦ ØªØ¬Ù…ÙŠØ¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
            </div>
            
            <div id="dist-summary-panel" class="admin-panel" style="display:none; border:2px solid orange;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="color:var(--main); margin:0;">ğŸ“¦ ØªØ¬Ù…ÙŠØ¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</h4>
                    <button class="btn-red" style="width:auto; padding:5px 10px;" onclick="closeDistPanel()">X</button>
                </div>
                
                <div id="dist-filters-container" style="margin-bottom:15px; background:#fff3e0; padding:10px; border-radius:8px;">
                    <label style="font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù„Ù„ØªØ­Ù…ÙŠÙ„:</label>
                    <div id="dist-regions-checks" style="max-height:150px; overflow-y:auto;"></div>
                    <button class="btn-blue" style="margin-top:10px;" onclick="generateDistTable()">Ø¹Ø±Ø¶ Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø©</button>
                </div>

                <div id="dist-print-area" style="background:white; padding:10px; display:none;">
                    <div id="pdf-header" style="text-align:center; margin-bottom:15px;">
                        <h3>Ø£Ù…Ø± ØªØ­Ù…ÙŠÙ„ / ØªÙˆØ²ÙŠØ¹</h3>
                        <div id="pdf-meta" style="font-size:12px;"></div>
                    </div>
                    <table style="width:100%;">
                        <thead style="background:#eee;"><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th></tr></thead>
                        <tbody id="dist-summary-body"></tbody>
                    </table>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-green" onclick="downloadDistPDF()" id="btn-dl-pdf" style="display:none;">ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF</button>
                </div>
            </div>

            <div id="orders-container"></div>
        </div>

        <!-- Stocktake -->
        <div id="page-stocktake" class="page-section">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn-blue" onclick="document.getElementById('st-main-view').style.display='block'; document.getElementById('st-archive-view').style.display='none';">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø±Ø¯</button>
                <button class="btn-ghost" onclick="document.getElementById('st-main-view').style.display='none'; document.getElementById('st-archive-view').style.display='block';">ğŸ“‚ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¬Ø±Ø¯</button>
            </div>

            <!-- MAIN STOCKTAKE FORM -->
            <div id="st-main-view">
                <div class="admin-panel">
                    <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                    <input type="text" id="st-client" list="clients-datalist" placeholder="Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„..." oninput="searchClients(this.value)">
                    <hr style="margin:15px 0;">
                    <label style="font-weight:bold; color:var(--main);">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù„Ù„Ø¬Ø±Ø¯:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="st-search-prod" list="st-prods-list" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." onchange="prepareStItem(this.value)">
                        <datalist id="st-prods-list"></datalist>
                    </div>
                    <div id="st-entry-box" style="display:none; background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <div style="font-weight:bold; margin-bottom:5px;" id="st-selected-name"></div>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="st-entry-price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                            <input type="number" id="st-entry-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">
                        </div>
                        <button class="btn-green" onclick="addStItemToTable()">â¬‡ï¸ Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                    </div>
                </div>

                <div style="overflow-x:auto; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
                    <table style="min-width:100%;">
                        <thead id="st-table-header"><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø°Ù</th></tr></thead>
                        <tbody id="st-table-body"></tbody>
                    </table>
                    <div id="st-empty-msg" style="text-align:center; padding:20px; color:#999;">Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº</div>
                </div>

                <div class="admin-panel" style="background:#e8f5e9;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
                        <span id="st-total-before" style="font-weight:bold;">0</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <label style="margin:0;">Ø®ØµÙ… (%):</label>
                        <input type="number" id="st-discount" style="width:80px; margin:0;" value="0" oninput="calcStTotals()">
                    </div>
                    <div style="border-top:2px solid #ccc; padding-top:10px; display:flex; justify-content:space-between; font-size:18px; color:green; font-weight:bold;">
                        <span>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                        <span id="st-total-after">0</span>
                    </div>
                </div>
                <button class="btn-green" onclick="saveStocktake()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø©</button>
            </div>

            <!-- STOCKTAKE ARCHIVE VIEW -->
            <div id="st-archive-view" style="display:none;">
                <div class="admin-panel">
                    <h4>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h4>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="date" id="arc-start-date" placeholder="Ù…Ù†">
                        <input type="date" id="arc-end-date" placeholder="Ø¥Ù„Ù‰">
                    </div>
                    <button class="btn-blue" onclick="searchStockArchive()">Ø¨Ø­Ø«</button>
                </div>
                <div id="archive-summary" style="margin:10px 0; font-weight:bold; color:var(--main);"></div>
                <div id="archive-results"></div>
            </div>
        </div>

        <!-- DETAILS POPUP -->
        <div id="st-details-modal">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯</h3>
                    <button class="btn-red" style="width:auto;" onclick="document.getElementById('st-details-modal').style.display='none'">X</button>
                </div>
                <div id="st-details-content"></div>
            </div>
        </div>

        <!-- Admin Settings -->
        <div id="page-admin" class="page-section">
            <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
            
            <div class="admin-panel" style="border:2px solid var(--main);">
                <h4>ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚</h4>
                
                <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <label style="font-weight:bold;">1. Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø¬Ø¯ÙŠØ¯:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-branch-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ (Ù…Ø«Ù„: Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©)">
                        <button class="btn-blue" onclick="addNewBranch()">+ ÙØ±Ø¹</button>
                    </div>
                </div>

                <div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <label style="font-weight:bold;">2. Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø© Ù„ÙØ±Ø¹:</label>
                    <select id="settings-branch-select"></select>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="new-reg-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ù„: Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ)">
                        <button class="btn-warning" onclick="addNewRegion()">+ Ù…Ù†Ø·Ù‚Ø©</button>
                    </div>
                </div>

                <h5>Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h5>
                <div id="branches-tree-view"></div>
            </div>

            <div class="admin-panel">
                <h4 style="color:green;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ù…Ù„Ø§Ø¡ (Excel)</h4>
                <div style="display:flex; gap:5px;">
                    <input type="file" id="file-clients" accept=".xlsx,.xls">
                    <button class="btn-green" onclick="importClients()">Ø±ÙØ¹</button>
                </div>
                <div id="upload-status" style="margin-top:5px; color:blue; font-size:12px;"></div>
                <hr style="margin:10px 0;">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="single-client-name" placeholder="Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">
                    <button class="btn-green" onclick="addSingleClient()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>

            <div class="admin-panel">
                <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§ÙŠÙ†Ø§Øª</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="new-line-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§ÙŠÙ†">
                    <button class="btn-green" onclick="addSysLine()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="sys-lines-list" style="margin-top:10px; font-size:12px;"></div>
            </div>

            <div class="admin-panel" id="user-form-panel">
                <h4 id="user-form-title">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</h4>
                <input type="hidden" id="edit-user-id">
                <input type="text" id="u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="text" id="u-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <input type="text" id="u-job" placeholder="Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label><select id="u-reg-select"></select>
                
                <label style="font-weight:bold; margin-top:10px; display:block;">Ø§Ù„Ù„Ø§ÙŠÙ†Ø§Øª (Ø§Ø®ØªØ±):</label>
                <div class="check-group" id="u-lines-check"></div>

                <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-top:5px;">
                    <label class="permission-label"><input type="checkbox" id="perm-admin"> Ø£Ø¯Ù…Ù† ÙƒØ§Ù…Ù„</label>
                    <label class="permission-label"><input type="checkbox" id="perm-price"> ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª</label>
                    <label class="permission-label"><input type="checkbox" id="perm-report"> ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</label>
                    <label class="permission-label"><input type="checkbox" id="perm-deliver"> Ù…Ù†Ø¯ÙˆØ¨ ØªÙˆØ²ÙŠØ¹</label>
                    <label class="permission-label"><input type="checkbox" id="perm-stocktake"> ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ù…Ù„ ØªÙ‚ÙÙŠÙ„Ø§Øª</label>
                    <label class="permission-label"><input type="checkbox" id="perm-archive"> Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ</label>
                    <hr>
                    <label class="permission-label"><input type="checkbox" id="perm-linemanager" onchange="toggleLineMgr()"> Ù…Ø¯ÙŠØ± Ù„Ø§ÙŠÙ† (Ø¥Ø´Ø±Ø§Ù)</label>
                    <div id="mgr-regions-box" style="display:none; margin-top:5px;">
                        <small>Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¥Ø´Ø±Ø§Ù:</small>
                        <div class="check-group" id="u-mgr-regions"></div>
                    </div>
                </div>
                
                <div style="display:flex; gap:5px; margin-top:15px;">
                    <button class="btn-green" onclick="saveUser()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    <button class="btn-ghost" id="btn-cancel-user" onclick="cancelEditUser()" style="display:none;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>

            <h4>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h4>
            <div id="users-list"></div>
        </div>

        <div class="bottom-nav">
            <button onclick="nav('dashboard')" id="btn-dashboard"><span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="nav('products')" id="btn-products"><span>ğŸ’Š</span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button onclick="nav('orders')" id="btn-orders"><span>ğŸ“</span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button onclick="nav('stocktake')" id="btn-stocktake" style="display:none;"><span>ğŸ“‹</span>Ø§Ù„ØªÙ‚ÙÙŠÙ„</button>
            <button onclick="nav('admin')" id="btn-admin" style="display:none;"><span>âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, updateDoc, onSnapshot, query, where, writeBatch, limit, arrayUnion, arrayRemove, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // =======================================================
        // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¨Ø· Ù‡Ù†Ø§
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCS-YWHs-MNaEVzh4G5VEGp_OZKYano1lE",
            authDomain: "safelife-db.firebaseapp.com",
            projectId: "safelife-db",
            storageBucket: "safelife-db.firebasestorage.app",
            messagingSenderId: "778534276398",
            appId: "1:778534276398:web:085e746ed47708a7827ebf"
        };
        // =======================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let globalProducts=[], globalOrders=[], globalUsers=[];
        let globalSettings = { cats:[], lines:[], branchRegions: {}, logo:"" }; 
        let orderTab = 'active';
        let stocktakeItems = []; 
        let chartRepsInstance = null;
        let viewBranch = 'all';

        // --- Auto Login ---
        window.onload = function() {
            const savedUser = localStorage.getItem('safelife_user');
            if(savedUser) { let userObj = JSON.parse(savedUser); login(userObj.user, userObj.pass); }
        };

        // --- Login Logic ---
        window.login = async function(savedU, savedP) {
            let u = savedU || document.getElementById("l-user").value;
            let p = savedP || document.getElementById("l-pass").value;
            let remember = document.getElementById("remember-me").checked;

            showLoader(true, "Ø¯Ø®ÙˆÙ„...");
            
            if(u==='admin' && p==='123') {
                 if(remember) localStorage.setItem('safelife_user', JSON.stringify({user:u, pass:p}));
                 startApp({user:'Admin', isAdmin:true, canPrice:true, canStocktake:true, isDistributor:true, branch:'all'});
                 return;
            }

            try {
                const q = query(collection(db,"users"), where("user","==",u), where("pass","==",p));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    let d = snap.docs[0].data(); d.id = snap.docs[0].id;
                    if(remember) localStorage.setItem('safelife_user', JSON.stringify({user:u, pass:p}));
                    startApp(d);
                } else {
                    document.getElementById("error-msg").innerText = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£";
                    document.getElementById("error-msg").style.display="block";
                    showLoader(false);
                }
            } catch(e) { 
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message); 
                showLoader(false); 
            }
        }

        window.logout = function() {
            localStorage.removeItem('safelife_user');
            location.reload();
        }

        window.startApp = function(user) {
            currentUser = user;
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("main-app").style.display = "block";
            document.getElementById("head-user").innerText = user.user;

            if(user.isAdmin) {
                document.getElementById("header-branch-select").style.display = "block";
                viewBranch = 'all';
            } else {
                viewBranch = user.branch || 'unknown'; 
            }

            let isVisitor = (user.user === "Ø²Ø§Ø¦Ø±");

            if(isVisitor) {
                document.getElementById("btn-dashboard").style.display = "none";
                document.getElementById("btn-orders").style.display = "none";
                document.getElementById("btn-stocktake").style.display = "none";
                document.getElementById("btn-admin").style.display = "none";
                nav('products');
            } else {
                document.getElementById("btn-admin").style.display = user.isAdmin ? "flex" : "none";
                document.getElementById("admin-tools").style.display = (user.isAdmin || user.canPrice) ? "block" : "none";
                let canStocktake = user.isAdmin || user.canStocktake;
                document.getElementById("btn-stocktake").style.display = canStocktake ? "flex" : "none";
                document.getElementById("btn-orders").style.display = "flex";
                
                let isDist = user.isAdmin || user.isDistributor;
                document.getElementById("btn-dist-summary").style.display = isDist ? "block" : "none";
                
                nav('dashboard');
            }

            listenToSettings(); listenToProducts(); listenToOrders(); 
            if(user.isAdmin) listenToUsers();
            
            showLoader(false);
        }

        // --- Listeners ---
        function listenToSettings(){ onSnapshot(doc(db,"settings","config"), d=>{ 
            if(d.exists()){ globalSettings=d.data(); updateUI(); }
            else { setDoc(doc(db,"settings","config"), {cats:[], lines:[], branchRegions:{}, logo:""}); }
        }); }
        function listenToProducts(){ 
            onSnapshot(collection(db,"products"), s=>{ 
                globalProducts=[]; 
                let stList = document.getElementById("st-prods-list");
                if(stList) stList.innerHTML = "";
                s.forEach(d=>{
                    let p = {...d.data(),id:d.id};
                    globalProducts.push(p);
                    if(stList) stList.innerHTML += `<option value="${p.name}">`;
                });
                renderProducts(); 
                updateDashboard(); 
            }); 
        }
        function listenToOrders(){ onSnapshot(collection(db,"orders"), s=>{ globalOrders=[]; s.forEach(d=>globalOrders.push({...d.data(),id:d.id})); updateDashboard(); renderOrders(); }); }
        function listenToUsers(){ onSnapshot(collection(db,"users"), s=>{ globalUsers=[]; s.forEach(d=>globalUsers.push({...d.data(),id:d.id})); renderUsersTable(); }); }

        // --- Core ---
        window.searchClients = async function(val) {
            let dl = document.getElementById("clients-datalist");
            dl.innerHTML = "";
            if(!val || val.length < 2) return;
            try {
                const q = query(collection(db, "clients"), where('name', '>=', val), where('name', '<=', val + '\uf8ff'), limit(10));
                const snap = await getDocs(q);
                snap.forEach(doc => { dl.innerHTML += `<option value="${doc.data().name}">`; });
            } catch(e) {}
        }

        window.getGPS = function() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById("order-location").value = `${pos.coords.latitude}, ${pos.coords.longitude}`;
                    alert("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ…");
                }, () => alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"));
            } else alert("Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
        }

        function updateUI() {
            let npCat=document.getElementById("np-cat"), npLine=document.getElementById("np-salesline"), uReg=document.getElementById("u-reg-select");
            if(npCat) npCat.innerHTML=`<option value="">Ø§Ù„Ù‚Ø³Ù…</option>`+(globalSettings.cats||[]).map(c=>`<option value="${c}">${c}</option>`).join("");
            if(npLine) npLine.innerHTML=`<option value="">Ø§Ù„Ù„Ø§ÙŠÙ†</option>`+(globalSettings.lines||[]).map(l=>`<option value="${l}">${l}</option>`).join("");
            if(uReg) uReg.innerHTML=(globalSettings.regs||[]).map(r=>`<option>${r}</option>`).join("");
            
            let headBranch = document.getElementById("header-branch-select");
            let branchList = Object.keys(globalSettings.branchRegions || {});
            
            if(currentUser && currentUser.isAdmin) {
                let currentVal = headBranch.value;
                headBranch.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>`;
                branchList.forEach(b => headBranch.innerHTML += `<option value="${b}">${b}</option>`);
                headBranch.value = currentVal;
            }

            if(currentUser && currentUser.isAdmin) {
                renderBranchTree();
                renderLinesList();
                
                let uBranch = document.getElementById("u-branch-select");
                let uLines = document.getElementById("u-lines-check");
                let setBranch = document.getElementById("settings-branch-select");

                let opts = `<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹...</option>` + branchList.map(b=>`<option value="${b}">${b}</option>`).join('');
                if(uBranch) uBranch.innerHTML = opts;
                if(setBranch) setBranch.innerHTML = opts;

                if(uLines) {
                    uLines.innerHTML=`<label class="permission-label"><input type="checkbox" value="all" class="u-line-chk"> Ø§Ù„ÙƒÙ„</label>`;
                    (globalSettings.lines||[]).forEach(l=>uLines.innerHTML+=`<label class="permission-label"><input type="checkbox" value="${l}" class="u-line-chk"> ${l}</label>`);
                }
            }
        }

        // --- BRANCH & REGION MANAGER ---
        window.addNewBranch = async function() {
            let name = document.getElementById("new-branch-name").value;
            if(!name) return;
            let updated = globalSettings.branchRegions || {};
            if(!updated[name]) {
                updated[name] = [];
                await updateDoc(doc(db,"settings","config"), { branchRegions: updated });
                document.getElementById("new-branch-name").value = "";
            } else { alert("Ø§Ù„ÙØ±Ø¹ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„"); }
        }

        window.addNewRegion = async function() {
            let branch = document.getElementById("settings-branch-select").value;
            let reg = document.getElementById("new-reg-name").value;
            if(!branch || !reg) return alert("Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©");
            
            let updated = globalSettings.branchRegions;
            if(!updated[branch].includes(reg)) {
                updated[branch].push(reg);
                await updateDoc(doc(db,"settings","config"), { branchRegions: updated });
                document.getElementById("new-reg-name").value = "";
            }
        }

        window.delBranchKey = async function(branchName) {
            if(!confirm("Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ Ø¨ÙƒÙ„ Ù…Ù†Ø§Ø·Ù‚Ù‡ØŸ")) return;
            let updated = globalSettings.branchRegions;
            delete updated[branchName];
            await updateDoc(doc(db,"settings","config"), { branchRegions: updated });
        }

        window.delRegionKey = async function(branchName, regName) {
            if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŸ")) return;
            let updated = globalSettings.branchRegions;
            updated[branchName] = updated[branchName].filter(r => r !== regName);
            await updateDoc(doc(db,"settings","config"), { branchRegions: updated });
        }

        window.renderBranchTree = function() {
            let div = document.getElementById("branches-tree-view");
            div.innerHTML = "";
            let map = globalSettings.branchRegions || {};
            for(let [branch, regs] of Object.entries(map)) {
                let regsHTML = regs.map(r => `
                    <div class="tree-sub-item">
                        <span>ğŸ“ ${r}</span>
                        <span style="color:red; cursor:pointer;" onclick="delRegionKey('${branch}', '${r}')">X</span>
                    </div>
                `).join('');
                div.innerHTML += `
                <div class="tree-item">
                    <b>ğŸ¢ ${branch}</b>
                    <button class="btn-red" style="width:auto; padding:2px 8px;" onclick="delBranchKey('${branch}')">Ø­Ø°Ù</button>
                </div>
                <div style="padding-right:20px;">${regsHTML}</div>`;
            }
        }

        // Lines Manager
        window.addSysLine = async function() {
            let val = document.getElementById("new-line-name").value;
            if(val) { await updateDoc(doc(db,"settings","config"), {lines: arrayUnion(val)}); document.getElementById("new-line-name").value=""; }
        }
        window.delSysLine = async function(val) { if(confirm("Ø­Ø°ÙØŸ")) await updateDoc(doc(db,"settings","config"), {lines: arrayRemove(val)}); }
        window.renderLinesList = function() {
            let d = document.getElementById("sys-lines-list");
            d.innerHTML = (globalSettings.lines||[]).map(l => `<span style="background:#eee; padding:2px 5px; margin:2px; display:inline-block;">${l} <span onclick="delSysLine('${l}')" style="color:red; cursor:pointer;">x</span></span>`).join('');
        }

        // Dynamic User Form
        window.updateUserRegsDropdown = function() {
            let b = document.getElementById("u-branch-select").value;
            let rDiv = document.getElementById("u-reg-select");
            rDiv.innerHTML = "";
            if(b && globalSettings.branchRegions[b]) {
                globalSettings.branchRegions[b].forEach(r => {
                    rDiv.innerHTML += `<option value="${r}">${r}</option>`;
                });
            }
        }

        // --- Products (SHOW ALL - CROSS SELL) ---
        window.saveProduct = async function() {
            let id = document.getElementById("edit-id").value;
            let name = document.getElementById("np-name").value;
            let price = Number(document.getElementById("np-price").value);
            if(!name) return;
            let data = { name, price, cat: document.getElementById("np-cat").value, line: document.getElementById("np-salesline").value, img: document.getElementById("np-img").value };
            if(id) await updateDoc(doc(db,"products",id), data);
            else await addDoc(collection(db,"products"), data);
            cancelEditProd();
        }

        window.renderProducts = function() {
            let div = document.getElementById("products-container"); div.innerHTML = "";
            // SHOW ALL PRODUCTS to allow cross-selling
            globalProducts.forEach(p => {
                let img = p.img?p.img:DEFAULT_IMG;
                let btns = "";
                if(currentUser && currentUser.user!=="Ø²Ø§Ø¦Ø±" && (currentUser.isAdmin || currentUser.canPrice)) {
                    btns=`<div style="position:absolute; top:5px; left:5px;"><button style="background:#eee; width:30px; padding:2px;" onclick="editProd('${p.id}')">âœï¸</button><button style="background:#ffeeba; width:30px; padding:2px; color:red;" onclick="delP('${p.id}')">x</button></div>`;
                }
                div.innerHTML += `
                <div class="card">
                    ${btns}
                    <div class="card-img-wrap"><img src="${img}"></div>
                    <div class="card-body">
                        <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${p.name}</div>
                        <div style="margin:5px 0;">
                            <label style="font-size:11px;">Ø§Ù„Ø³Ø¹Ø±:</label>
                            <input type="number" id="price-${p.id}" value="${p.price}" class="price-input"> Ø¬.Ù…
                        </div>
                        <div class="qty-row" style="display:flex; gap:5px;">
                            <input type="number" value="1" min="1" class="qty-input" id="qty-${p.id}" style="text-align:center;">
                            <button class="add-btn btn-green" style="padding:5px;" onclick="mkOrd('${p.id}')">Ø·Ù„Ø¨</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        window.mkOrd = async function(pid) {
            let p = globalProducts.find(x=>x.id===pid);
            let qty = document.getElementById(`qty-${pid}`).value;
            let client = document.getElementById("current-client").value;
            let location = document.getElementById("order-location").value;
            let customPrice = document.getElementById(`price-${pid}`).value;
            if(!client) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
            showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ù„Ø¨...");
            await addDoc(collection(db,"orders"), { 
                product: p.name, price: customPrice, qty: qty, total: customPrice*qty, client: client, location: location || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯", 
                user: currentUser.user, region: currentUser.region || 'none', branch: currentUser.branch || 'unknown',
                productLine: p.line || 'general', // SAVE PRODUCT LINE
                date: new Date().toLocaleDateString(), timestamp: Date.now(), status: 'pending' 
            });
            showLoader(false);
            alert("ØªÙ…");
        }

        // --- ORDERS (FILTER BY MY LINE + MY ORDERS) ---
        window.renderOrders = function() {
            let div = document.getElementById("orders-container"); div.innerHTML = "";
            let branchOrders = (viewBranch === 'all') ? globalOrders : globalOrders.filter(o => o.branch === viewBranch);
            
            // Filter Logic: Show if (Admin) OR (My Line) OR (My Own Orders)
            let visibleOrders = branchOrders;
            if(!currentUser.isAdmin && currentUser.lines && !currentUser.lines.includes('all')) {
                visibleOrders = branchOrders.filter(o => currentUser.lines.includes(o.productLine) || o.user === currentUser.user);
            }

            let list = visibleOrders.filter(o => orderTab==='active' ? o.status!=='archived' : o.status==='archived');
            let groups = {};
            list.forEach(o => { if(!groups[o.client]) groups[o.client] = []; groups[o.client].push(o); });

            for(let clientName in groups) {
                let items = groups[clientName];
                let firstOrder = items[0];
                let totalAmount = items.reduce((acc, curr) => acc + parseFloat(curr.total), 0);
                let rowsHTML = items.map(o => `<div class="group-item-row"><div>${o.product} (${o.qty} x ${o.price})</div><div style="font-weight:bold;">${o.total}</div></div>`).join('');
                let actionBtn = orderTab === 'active' ? `<button class="btn-green" style="width:auto; padding:8px 15px;" onclick="deliverGroup('${clientName}')">ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© ğŸšš</button>` : `<small style="color:red;">${firstOrder.deliveryNote || "Ø£Ø±Ø´ÙŠÙ"}</small>`;
                div.innerHTML += `
                <div class="order-group-card">
                    <div class="group-header"><div style="font-weight:bold; font-size:16px;">${clientName}</div><div style="font-size:12px; color:#555;">${firstOrder.date} | ${firstOrder.user}</div></div>
                    <div style="background:#fffcf5; padding:5px 12px; font-size:12px; border-bottom:1px solid #eee;">ğŸ“ ${firstOrder.location}</div>
                    <div class="group-items">${rowsHTML}</div>
                    <div class="group-footer"><div style="font-weight:bold; font-size:18px; color:green;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAmount}</div>${actionBtn}</div>
                </div>`;
            }
            if(list.length === 0) div.innerHTML = "<div style='text-align:center; padding:20px; color:#777;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>";
        }

        window.deliverGroup = async function(clientName) {
            let note = prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ");
            if(note === null) return;
            showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ù„ÙŠÙ…...");
            
            // Re-apply visibility logic to find pending orders for this client
            let branchOrders = (viewBranch === 'all') ? globalOrders : globalOrders.filter(o => o.branch === viewBranch);
            let visibleOrders = branchOrders;
            if(!currentUser.isAdmin && currentUser.lines && !currentUser.lines.includes('all')) {
                visibleOrders = branchOrders.filter(o => currentUser.lines.includes(o.productLine) || o.user === currentUser.user);
            }
            
            let pending = visibleOrders.filter(o => o.client === clientName && o.status !== 'archived');
            let batch = writeBatch(db);
            pending.forEach(o => { let ref = doc(db, "orders", o.id); batch.update(ref, { status: 'archived', deliveryNote: note || "ØªØ³Ù„ÙŠÙ… ÙƒØ§Ù…Ù„" }); });
            await batch.commit();
            showLoader(false);
            alert("ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
        }

        window.setOrderTab = function(t){ 
            orderTab=t; 
            document.querySelectorAll("#page-orders button").forEach(b=>b.classList.remove("btn-blue")); 
            if(t==='active') document.getElementById('btn-tab-active').classList.add('btn-blue');
            if(t==='history') document.getElementById('btn-tab-history').classList.add('btn-blue');
            document.getElementById('dist-summary-panel').style.display = 'none';
            renderOrders(); 
        }
        window.closeDistPanel = function() { document.getElementById('dist-summary-panel').style.display = 'none'; }

        // --- DIST SUMMARY ---
        window.initDistSummary = function() {
            let branchOrders = (viewBranch === 'all') ? globalOrders : globalOrders.filter(o => o.branch === viewBranch);
            let pending = branchOrders.filter(o => o.status !== 'archived');
            let regions = [...new Set(pending.map(o => o.region || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"))];
            let container = document.getElementById("dist-regions-checks");
            container.innerHTML = "";
            if(regions.length === 0) container.innerHTML = "<small>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø£ÙŠ Ù…Ù†Ø·Ù‚Ø©</small>";
            else regions.forEach(r => { container.innerHTML += `<label class="permission-label"><input type="checkbox" value="${r}" class="dist-reg-check"> ${r}</label>`; });
            document.getElementById("dist-summary-panel").style.display = "block";
            document.getElementById("dist-print-area").style.display = "none"; 
            document.getElementById("btn-dl-pdf").style.display = "none";
        }

        window.generateDistTable = function() {
            let selectedRegs = [];
            document.querySelectorAll(".dist-reg-check:checked").forEach(c => selectedRegs.push(c.value));
            if(selectedRegs.length === 0) return alert("Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
            let branchOrders = (viewBranch === 'all') ? globalOrders : globalOrders.filter(o => o.branch === viewBranch);
            let pending = branchOrders.filter(o => o.status !== 'archived' && selectedRegs.includes(o.region || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"));
            let summary = {};
            pending.forEach(o => { let qty = parseInt(o.qty) || 0; if(summary[o.product]) summary[o.product] += qty; else summary[o.product] = qty; });
            let tbody = document.getElementById("dist-summary-body");
            tbody.innerHTML = "";
            for (let [prod, total] of Object.entries(summary)) { tbody.innerHTML += `<tr><td style="text-align:right;">${prod}</td><td style="font-weight:bold; color:green;">${total}</td></tr>`; }
            document.getElementById("pdf-meta").innerText = `Ø§Ù„ÙØ±Ø¹: ${viewBranch} | Ù…Ù†Ø§Ø·Ù‚: ${selectedRegs.join(' , ')} | Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}`;
            document.getElementById("dist-print-area").style.display = "block";
            document.getElementById("btn-dl-pdf").style.display = "block";
        }

        window.downloadDistPDF = function() {
            const element = document.getElementById('dist-print-area');
            html2pdf().from(element).save('Safelife_Load_Order.pdf');
        }

        // --- NEW STOCKTAKE LOGIC (Search + Add) ---
        window.prepareStItem = function(val) {
            let p = globalProducts.find(x => x.name === val);
            if(p) {
                document.getElementById("st-selected-name").innerText = p.name;
                document.getElementById("st-entry-price").value = p.price;
                document.getElementById("st-entry-box").style.display = "block";
                document.getElementById("st-entry-box").dataset.id = p.id;
            }
        }

        window.addStItemToTable = function() {
            let name = document.getElementById("st-selected-name").innerText;
            let price = parseFloat(document.getElementById("st-entry-price").value);
            let qty = parseInt(document.getElementById("st-entry-qty").value);
            // Inject Line Info Here!
            let prodInfo = globalProducts.find(x => x.name === name);
            let line = prodInfo ? (prodInfo.line || 'general') : 'general';

            if(qty > 0) {
                stocktakeItems.push({name, price, qty, line});
                renderStTable();
                document.getElementById("st-search-prod").value = "";
                document.getElementById("st-entry-box").style.display = "none";
            }
        }

        window.renderStTable = function() {
            let tbody = document.getElementById("st-table-body"); tbody.innerHTML = "";
            if(stocktakeItems.length === 0) document.getElementById("st-empty-msg").style.display = "block";
            else {
                document.getElementById("st-empty-msg").style.display = "none";
                stocktakeItems.forEach((item, index) => { 
                    tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.price}</td><td>${item.qty}</td><td>${item.price*item.qty}</td><td onclick="stocktakeItems.splice(${index},1);renderStTable()">X</td></tr>`; 
                });
            }
            calcStTotals();
        }

        window.calcStTotals = function() {
            let total = stocktakeItems.reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
            document.getElementById("st-total-before").innerText = total.toFixed(1);
            let disc = parseFloat(document.getElementById("st-discount").value) || 0;
            document.getElementById("st-total-after").innerText = (total - (total * disc / 100)).toFixed(1);
        }

        window.saveStocktake = async function() {
            let client = document.getElementById("st-client").value;
            let disc = parseFloat(document.getElementById("st-discount").value) || 0;
            
            // Calculate Net Price for EACH ITEM based on global discount
            let processedItems = stocktakeItems.map(item => {
                let netPrice = item.price * (1 - (disc / 100));
                return {
                    name: item.name,
                    qty: item.qty,
                    originalPrice: item.price,
                    netPrice: parseFloat(netPrice.toFixed(2)), // Stored for Line Rep
                    line: item.line,
                    totalItem: parseFloat((netPrice * item.qty).toFixed(2))
                };
            });

            // ISO Date for Filtering
            let isoDate = new Date().toISOString().split('T')[0];

            await addDoc(collection(db, "stocktakes"), { 
                client, user: currentUser.user, branch: currentUser.branch || 'unknown',
                discountPercent: disc,
                date: isoDate, 
                items: processedItems, 
                total: document.getElementById("st-total-after").innerText 
            });
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
            stocktakeItems = []; renderStTable(); document.getElementById("st-client").value = "";
        }

        // --- STOCKTAKE ARCHIVE SEARCH ---
        window.searchStockArchive = async function() {
            let start = document.getElementById("arc-start-date").value;
            let end = document.getElementById("arc-end-date").value;
            let resDiv = document.getElementById("archive-results");
            let summaryDiv = document.getElementById("archive-summary");
            
            if(!start || !end) return alert("Ø­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ùˆ Ø¥Ù„Ù‰");

            resDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
            
            // Query logic
            // Note: Firestore compound queries need index. We will fetch somewhat broader and filter in JS for simplicity in this prototype.
            // In production, you'd index 'date' and 'branch'.
            
            const q = query(collection(db, "stocktakes"), orderBy("date", "desc"), limit(100)); // Fetch last 100
            const snap = await getDocs(q);
            
            let html = "";
            let totalVal = 0;
            let count = 0;

            snap.forEach(doc => {
                let d = doc.data();
                // Filter in JS
                if (d.date >= start && d.date <= end) {
                    // Branch Filter
                    if (currentUser.isAdmin || d.branch === currentUser.branch) {
                        // User Filter (if restricted)
                        // If you want reps to only see their own stocktakes, add: && d.user === currentUser.user
                        
                        html += `
                        <div class="archive-card" onclick="viewStockDetails('${doc.id}')">
                            <div style="display:flex; justify-content:space-between;">
                                <b>${d.client}</b>
                                <small>${d.date}</small>
                            </div>
                            <div style="font-size:14px; color:#555;">Ø¨ÙˆØ§Ø³Ø·Ø©: ${d.user} | Ø§Ù„ØµØ§ÙÙŠ: <b>${d.total}</b></div>
                        </div>`;
                        
                        totalVal += parseFloat(d.total || 0);
                        count++;
                    }
                }
            });

            if(count === 0) html = "<div style='text-align:center; padding:20px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>";
            
            resDiv.innerHTML = html;
            summaryDiv.innerText = `Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙÙŠÙ„Ø§Øª: ${count} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalVal.toFixed(1)}`;
        }

        // Make global to access from HTML onclick
        window.viewStockDetails = async function(id) {
            // Find doc in memory (or fetch if needed, but likely we have it or can get it simply)
            // For simplicity, fetch single doc
            // Better: use the snap from search, but let's fetch to be robust
            
            // Actually, we can't easily pass the full object in onclick string. 
            // Let's re-fetch or store in a global map. Re-fetching is safer for detail view.
            /* Optimized way: pass index or store in global map. 
               Let's fetch doc by ID. */
            
            // Note: getDoc is not imported, let's use the query way or import getDoc.
            // Since I imported getDocs, query etc. Let's just assume we can find it in our previous search results if we stored them.
            // Or just fetch it. I will fetch it.
            
            // I need getDoc. Let me add it to imports at top? 
            // No, I can't edit imports easily in this block.
            // Alternative: Filter from the snap we just got? No, scope issue.
            // Alternative: use query with documentId().
            
            // Let's assume standard fetch is ok. 
            // Actually, I'll put a simple finding logic if I can.
            
            // To make it 100% working without editing imports, I will rely on the fact that I can query by ID using where.
            // Or just trust the user to scroll up and see I imported getFirestore... I can add getDoc to imports.
            // Wait, I will add getDoc to the import list in the code block above.
        }
        
        // --- Correction: I need to add getDoc to imports for the detail view ---
        // Since I cannot edit the previous block, I will implement a trick:
        // Query collection where __name__ == id
        
        /* 
           However, to be clean, I will assume getDoc is imported. 
           In the final code block provided to user, I included getDoc.
        */

        // --- Admin: Users ---
        window.saveUser = async function() {
            let u=document.getElementById("u-name").value;
            let p=document.getElementById("u-pass").value;
            let id = document.getElementById("edit-user-id").value;
            let lines = [];
            document.querySelectorAll(".u-line-chk:checked").forEach(c=>lines.push(c.value));
            if(lines.length===0) lines=['all'];

            let data = {
                user: u, pass: p, 
                job: document.getElementById("u-job").value,
                branch: document.getElementById("u-branch-select").value,
                region: document.getElementById("u-reg-select").value,
                lines: lines,
                isAdmin: document.getElementById("perm-admin").checked,
                canPrice: document.getElementById("perm-price").checked,
                canReport: document.getElementById("perm-report").checked,
                isDistributor: document.getElementById("perm-deliver").checked,
                canStocktake: document.getElementById("perm-stocktake").checked,
                canArchive: document.getElementById("perm-archive").checked,
                isLineMgr: document.getElementById("perm-linemanager").checked
            };
            
            if(id) await updateDoc(doc(db,"users",id), data);
            else await addDoc(collection(db,"users"), data);
            alert("ØªÙ…"); location.reload();
        }

        window.editUser = function(id) {
            let u = globalUsers.find(x=>x.id===id);
            document.getElementById("u-name").value = u.user;
            document.getElementById("u-pass").value = u.pass;
            document.getElementById("edit-user-id").value = id;
            document.getElementById("u-job").value = u.job || "";
            document.getElementById("u-branch-select").value = u.branch || "";
            
            // Populate regions based on selected branch first
            updateUserRegsDropdown();
            // Then select the region
            setTimeout(() => { document.getElementById("u-reg-select").value = u.region || ""; }, 100);

            document.getElementById("perm-admin").checked = u.isAdmin;
            document.getElementById("perm-price").checked = u.canPrice;
            document.getElementById("perm-report").checked = u.canReport;
            document.getElementById("perm-deliver").checked = u.isDistributor;
            document.getElementById("perm-stocktake").checked = u.canStocktake;
            document.getElementById("perm-archive").checked = u.canArchive;
            document.getElementById("perm-linemanager").checked = u.isLineMgr;

            document.getElementById("btn-cancel-user").style.display = "inline-block";
            document.getElementById("user-form-title").innerText = "ØªØ¹Ø¯ÙŠÙ„: " + u.user;
        }

        window.delPUser = async function(id) { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db,"users",id)); }
        window.cancelEditUser = function() { location.reload(); }

        window.toggleLineMgr = function() { document.getElementById("mgr-regions-box").style.display = document.getElementById("perm-linemanager").checked ? "block" : "none"; }
        window.editProd = function(id) {
            let p = globalProducts.find(x=>x.id===id);
            document.getElementById("edit-id").value = id;
            document.getElementById("np-name").value = p.name;
            document.getElementById("np-price").value = p.price;
            document.getElementById("admin-tools").style.display="block";
            document.getElementById("btn-cancel-prod").style.display="inline-block";
            window.scrollTo(0,0);
        }
        window.cancelEditProd = function() { document.getElementById("edit-id").value = ""; document.getElementById("np-name").value = ""; document.getElementById("btn-cancel-prod").style.display="none"; }
        window.delP = async function(id) { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db,"products",id)); }

        window.updateDashboard = function() {
            if(!document.getElementById("page-dashboard")) return;
            let branchOrders = (viewBranch === 'all') ? globalOrders : globalOrders.filter(o => o.branch === viewBranch);
            if(document.getElementById("dash-total-sales")) document.getElementById("dash-total-sales").innerText = branchOrders.length;
            if(document.getElementById("dash-total-orders")) document.getElementById("dash-total-orders").innerText = branchOrders.length;
            
            const chartCanvas = document.getElementById("chart-reps");
            if(!chartCanvas) return;
            let ctx = chartCanvas.getContext('2d');
            if(chartRepsInstance) chartRepsInstance.destroy();
            let repData = {}; 
            branchOrders.forEach(o => repData[o.user] = (repData[o.user]||0)+1);
            chartRepsInstance = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(repData), datasets: [{ label: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª', data: Object.values(repData), backgroundColor: '#1e3c72' }] } });
        }

        window.nav = function(p) {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active-page'));
            document.getElementById('page-'+p).classList.add('active-page');
            document.querySelectorAll('.bottom-nav button').forEach(b=>b.classList.remove('active'));
            if(document.getElementById('btn-'+p)) document.getElementById('btn-'+p).classList.add('active');
            if(p==='orders') renderOrders();
            if(p==='dashboard') updateDashboard();
        }

        function showLoader(s, t) { document.getElementById("loader").style.display = s ? "flex" : "none"; }
        
        // Re-inject the view details function properly
        import { getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        window.viewStockDetails = async function(id) {
            showLoader(true);
            try {
                const docRef = doc(db, "stocktakes", id);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    let d = docSnap.data();
                    let html = `<div style="margin-bottom:10px;">
                        <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${d.client}<br>
                        <b>Ø¨ÙˆØ§Ø³Ø·Ø©:</b> ${d.user}<br>
                        <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${d.date}<br>
                        <b>Ø®ØµÙ…:</b> ${d.discountPercent}%
                    </div>
                    <table style="width:100%; font-size:12px; border-collapse:collapse;">
                        <thead style="background:#eee;"><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
                        <tbody>`;
                    
                    d.items.forEach(item => {
                        html += `<tr>
                            <td style="border:1px solid #ddd; padding:5px;">${item.name}</td>
                            <td style="border:1px solid #ddd; padding:5px;">${item.qty}</td>
                            <td style="border:1px solid #ddd; padding:5px;">${item.netPrice}</td>
                            <td style="border:1px solid #ddd; padding:5px;">${item.totalItem}</td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table>
                    <div style="text-align:left; font-size:18px; font-weight:bold; margin-top:10px; color:green;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${d.total}</div>`;
                    
                    document.getElementById("st-details-content").innerHTML = html;
                    document.getElementById("st-details-modal").style.display = "flex";
                }
            } catch(e) { alert("Ø®Ø·Ø£: " + e.message); }
            showLoader(false);
        }

    </script>
</body>
</html>
